(function e(t,n,r){function i(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(s)return s(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return i(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var s=typeof require=="function"&&require;for(var o=0;o<r.length;o++)i(r[o]);return i})({1:[function(e,t,n){var r=e("./game-state"),i=r.TILE_SIZE,s=r.HALF_TILE;var o=t.exports=function(){"use strict";var e=1e3;setInterval(function(){e--;if(e===0){e=1e3}},64);return{tileHighlight:function(e,t,n,r){var s={x:t.x*i,y:t.y*i};e.strokeStyle=n;e.lineWidth=r;e.moveTo(s.x,s.y);e.strokeRect(s.x,s.y,i,i)},circle:function(e,t,n,r){e.beginPath();e.fillStyle=r;e.arc(t.x*i+s,t.y*i+s,n,0,Math.PI*2,false);e.fill()},line:function(e,t,n,r,i){e.beginPath();e.strokeStyle=r;e.lineWidth=i;e.moveTo(t.x,t.y);e.lineTo(n.x,n.y);e.stroke()},getLineDashOffset:function(){return e}}}()},{"./game-state":2}],2:[function(e,t,n){var r=t.exports={player:null,ship:null,selected:[],TILE_SIZE:32,HALF_TILE:16}},{}],3:[function(e,t,n){var r=e("underscore"),i=e("pathfinding"),s=e("shared"),o=e("./tile-entity-vm"),u=e("./draw");var a=o.extend({init:function(e,t,n){"use strict";this.onShipAnimations={normal:null,rotated:null};this.offShipAnimations={normal:null,rotated:null};if(n===undefined){n={}}if(!n.name){n.name="item"}this.parent(e,t,n)},updateAnimation:function(){"use strict";var e;if(this._onShip){if(this.m.rotated()){e=this.onShipAnimations.rotated}else{e=this.onShipAnimations.normal}}else{if(this.m.rotated()){e=this.offShipAnimations.rotated}else{e=this.offShipAnimations.normal}}if(e){this.setCurrentAnimation(e)}},canBuildAt:function(e,t,n){"use strict";return this.m.canBuildAt(e,t,n)},canBuildRotated:function(e,t,n){"use strict";return this.m.canBuildRotated(e,t,n)},rotated:function(e){"use strict";var t=this.m.rotated();if(e===undefined){return this.m.rotated()}if(e){this.angle=Math.PI/2}else{this.angle=0}this.m.rotated(e);if(t!==this.m.rotated()){this.updateAnimation()}return this},trueSize:function(e){"use strict";return this.m.trueSize(e)},tiles:function(e,t){"use strict";var n,r;for(n=this.x;n<this.trueSize(0)+this.x&&(!t||n<t.width)&&n>=0;n++){for(r=this.y;r<this.trueSize(1)+this.y&&(!t||r<t.height)&&r>=0;r++){e(n,r)}}},onBuilt:function(){"use strict";if(!me.state.isCurrent("ship-building")){console.error("item.onBuilt called when not building the ship")}},temp:{},_onShip:false,onShip:function(e){"use strict";var t=this._onShip;if(e===undefined){return this._onShip}this._onShip=e;if(t!==this._onShip){this.updateAnimation();if(e){this.whenOnShip()}else{this.whenOffShip()}}return this},whenOnShip:function(){"use strict";return""},whenOffShip:function(){"use strict";return""},toJson:function(){"use strict";var e=this;return{type:e.type,x:e.x,y:e.y,rotated:e.rotated(),settings:{}}}});var f={};f.Weapon=a.extend({init:function(e){"use strict";this.type="Weapon";this.size=e.size;this.totalSize=[3*s.GRID_SUB,2*s.GRID_SUB];this.m=e;this.parent(e.x,e.y,{});this.onShip(e.onShip());this.fireOffset={x:64,y:32}},update:function(){"use strict";if(this.firing){this.shotX+=32;return true}if(this.shotX>200){this.firing=false;return true}return this.parent()},draw:function(e){"use strict";this.parent(e);var t=s.v.add(this.pos,this.fireOffset),n=this.shotX-t.x;if(n>100){n=100}if(this.firing){e.save();u.line(e,{x:this.shotX,y:t.y},{x:this.shotX-n,y:t.y},"#2326D9",20);e.restore()}},playFire:function(){"use strict";this.firing=true;this.shotX=this.pos.x+this.fireOffset.x}});f.Engine=a.extend({init:function(e){"use strict";this.type="Engine";this.size=e.size;this.totalSize=[3*s.GRID_SUB,2*s.GRID_SUB];this.cannonTile=[s.GRID_SUB,0];this.m=e;this.parent(e.x,e.y,{});this.onShip(e.onShip())}});f.Power=a.extend({init:function(e){"use strict";this.type="Power";this.size=e.size;this.m=e;this.parent(e.x,e.y,{});this.onShip(e.onShip())}});f.Console=a.extend({init:function(e){"use strict";this.type="Console";this.size=e.size;this.m=e;this.parent(e.x,e.y,{});this.onShip(e.onShip())}});f.Component=a.extend({init:function(e){"use strict";this.type="Component";this.size=e.size;this.m=e;this.parent(e.x,e.y,{});this.addAnimation("idle",[3]);this.addAnimation("charge",[0,1,2,3,4,5,5]);this.offShipAnimations.normal="idle";this.onShipAnimations.normal="charge";this.animationspeed=15;this.setCurrentAnimation("idle");this.onShip(e.onShip())}});f.Door=a.extend({init:function(e){"use strict";this.type="Door";this.size=e.size;this.m=e;this.parent(e.x,e.y,{});this.addAnimation("idle",[2]);this.addAnimation("v_idle",[3]);this.addAnimation("h_open_close",[0,2,4,6,8,10,10,8,6,4,2,0]);this.addAnimation("v_open_close",[1,3,5,7,9,11,11,9,7,5,3,1]);this.anchorPoint.x=.25;this.anchorPoint.y=.5;this.offShipAnimations.normal="idle";this.offShipAnimations.rotated="v_idle";this.onShipAnimations.normal="h_open_close";this.onShipAnimations.rotated="v_open_close";this.animationspeed=10;this.setCurrentAnimation("idle");this.rotated(this.m.rotated());this.zIndex=110;this.onShip(e.onShip())}});f.Wall=a.extend({init:function(e){"use strict";this.type="Wall";this.size=e.size;this.m=e;this.parent(e.x,e.y,{});this.addAnimation("lr",[0]);this.addAnimation("tb",[1]);this.addAnimation("tr",[2]);this.addAnimation("tlr",[3]);this.addAnimation("tlbr",[4]);this.addAnimation("tl",[5]);this.addAnimation("br",[6]);this.addAnimation("lbr",[7]);this.addAnimation("lb",[8]);this.addAnimation("tlb",[9]);this.addAnimation("tbr",[10]);this.setCurrentAnimation("lr");this.animationspeed=6;this.onShip(e.onShip())},getModel:function(e){"use strict";if(e instanceof s.Item){return e}if(e instanceof a){return e.m}return null},updateAnimation:function(){"use strict";var e=me.state.current(),t=e.at(this.x,this.y-s.GRID_SUB),n=e.at(this.x-s.GRID_SUB,this.y),r=e.at(this.x,this.y+s.GRID_SUB),i=e.at(this.x+s.GRID_SUB,this.y),o=[],u;t=this.getModel(t);n=this.getModel(n);r=this.getModel(r);i=this.getModel(i);this.m.updateConnections(t,n,r,i);if(this.m.isHorizontal()){this.setCurrentAnimation("lr");return}if(this.m.isVertical()){this.setCurrentAnimation("tb");return}if(this.m.connected.top){o.push("t")}if(this.m.connected.left){o.push("l")}if(this.m.connected.bottom){o.push("b")}if(this.m.connected.right){o.push("r")}u=o.join("");this.setCurrentAnimation(u)},onBuilt:function(){"use strict";var e,t,n,o,u;this.parent();n=me.state.current();o=this.m.ship;u={width:o.width/s.GRID_SUB,height:o.height/s.GRID_SUB};if(n.mouseLockedOn===this){return}e=s.utils.getEmptyMatrix(u.width,u.height,1);e[this.y/s.GRID_SUB][this.x/s.GRID_SUB]=0;r.each(e,function(t,n){r.each(e,function(t,r){if(o.hullMap[n][r]===s.tiles.clear){e[n][r]=0}})});this.alpha=.8;if(n.chosen){n.chosen.hide()}t=this.temp;t.grid=new i.Grid(u.width,u.height,e);t.preMouseX=this.x;t.preMouseY=this.y;t.pivotX=this.x;t.pivotY=this.y;t.path=null;t.finder=new i.BestFirstFinder;n.mouseLockedOn=this},lockedMouseMove:function(e){"use strict";var t,n,i;i=me.state.current();t=this.temp;if(e.x===t.preMouseX&&e.y===t.preMouseY){return}t.preMouseX=e.x;t.preMouseY=e.y;i.clear();if(e.x===t.pivotX&&e.y===t.pivotY){t.path=null;return}n=t.grid.clone();t.path=t.finder.findPath(t.pivotX/s.GRID_SUB,t.pivotY/s.GRID_SUB,e.x/s.GRID_SUB,e.y/s.GRID_SUB,n);r.each(t.path,function(e,t){if(t>0){i.drawItem(e[0]*s.GRID_SUB,e[1]*s.GRID_SUB,"Wall")}})},lockedMouseUp:function(){"use strict";var e=me.state.current();r.each(e.drawingScreen,function(t){e.ship.buildAt(t.x,t.y,"Wall")});this.alpha=1;if(e.chosen){e.chosen.alpha=.8}this.temp={};e.clear();e.mouseLockedOn=null},lockedMouseDown:function(){"use strict";return 0},lockedEscape:function(){"use strict";var e=me.state.current();e.clear();if(e.chosen){e.chosen.alpha=.8}this.temp={};e.mouseLockedOn=null;e.ship.remove(this.m)}});f.WeakSpot=a.extend({init:function(e){"use strict";this.type="WeakSpot";this.size=e.size;this.m=e;this.parent(e.x,e.y,{});this.onShip(e.onShip());this.alpha=.75}});f.Teleporter=a.extend({init:function(e){"use strict";this.type="Teleporter";this.size=e.size;this.m=e;this.parent(e.x,e.y,{});this.onShip(e.onShip())}});n.ItemVM=a;n.itemVMs=f},{"./draw":1,"./tile-entity-vm":5,pathfinding:8,shared:38,underscore:41}],4:[function(e,t,n){me.plugin.patch(me.TMXTileMap,"load",function(){"use strict";this.parent();this.mapLayers.push(new me.ColorLayer("background_color","#000000",this.z-10))});me.state.pause=function(){"use strict";return 0};me.state.resume=function(){"use strict";return 0}},{}],5:[function(e,t,n){var r=e("underscore")._,i=e("./utils"),s=e("./game-state"),o=s.TILE_SIZE,u=e("shared");var a=t.exports=me.ObjectEntity.extend({x:0,y:0,size:[1,1],cannonTile:[0,0],isSelectable:false,init:function(e,t,n){"use strict";var i,a=false;this.screen=me.state.current();if(this.type!==0){i=this.type;n.image=this.type.toLowerCase()}if(!this.totalSize){this.totalSize=[this.size[0],this.size[1]]}if(n.spritewidth===undefined){n.spritewidth=this.totalSize[0]*o}if(n.spriteheight===undefined){n.spriteheight=this.totalSize[1]*o}this.parent(e,t,n);this.type=i;this.setX(e);this.setY(t);me.input.registerMouseEvent("mousedown",this,this.onMouseDown.bind(this));me.input.registerMouseEvent("mouseup",this,this.onMouseUp.bind(this));if(!this.selectionColor){this.selectionColor="teal"}this.selected=function(){return a};this.select=function(){a=true;if(!r.contains(s.selected,this)){s.selected.push(this)}this.onSelected()};this.deselect=function(){a=false;u.utils.removeFromArray(this,s.selected);this.onDeselected()}},update:function(){"use strict";this.parent();if(this.isSelectable&&this.isMouseOver){i.setCursor("pointer")}if(this.occupies(i.lastMouse)){if(!this.isMouseOver){this.onMouseEnter();this.isMouseOver=true}}else{if(this.isMouseOver){this.onMouseLeave();this.isMouseOver=false}}return true},draw:function(e){"use strict";this.parent(e);if(this.isSelectable){if(this.selected()){this.drawSelectedHightlight(e)}else if(this.isMouseOver){this.drawHoverHighlight(e)}}},drawHoverHighlight:function(e){"use strict";e.strokeStyle=this.selectionColor;e.lineWidth=1;e.moveTo(this.pos.x,this.pos.y);e.strokeRect(this.pos.x,this.pos.y,this.width,this.height)},drawSelectedHightlight:function(e){"use strict";e.strokeStyle=this.selectionColor;e.lineWidth=2;e.moveTo(this.pos.x,this.pos.y);e.strokeRect(this.pos.x,this.pos.y,this.width,this.height)},onMouseDown:function(){"use strict";return""},onMouseUp:function(){"use strict";if(this.isSelectable){this.select()}},onMouseEnter:function(){"use strict";return""},onMouseLeave:function(){"use strict";if(this.isSelectable){i.setCursor("default")}},onSelected:function(){"use strict";return""},onDeselected:function(){"use strict";return""},setX:function(e){"use strict";if(e===this.x){return this}this.x=e;this.pos.x=(this.x-this.cannonTile[0])*o;return this},setY:function(e){"use strict";if(e===this.y){return this}this.y=e;this.pos.y=(this.y-this.cannonTile[1])*o;return this},_hidden:false,hidden:function(e){"use strict";if(e===undefined){return this._hidden}if(e){this.alpha=0}else{this.alpha=1}this._hidden=e;return this},show:function(){"use strict";this.hidden(false);if(this.wasSelectable){this.isSelectable=true}return this},hide:function(){"use strict";this.hidden(true);if(this.isSelectable){if(this.selected()){this.deselect()}this.wasSelectable=true;this.isSelectable=false}return this},trueSize:function(e){"use strict";return this.size[e]},occupies:function(e){"use strict";var t=e.x,n=e.y;return t>=this.x&&t<this.x+this.trueSize(0)&&n>=this.y&&n<this.y+this.trueSize(1)},setTracked:function(e){"use strict";this.prevModelState={};r.each(e,function(e){this.prevModelState[e]=this.m[e]},this)},notifyModelChange:function(){"use strict";var e=this,t={};r.each(this.prevModelState,function(n,r){if(e.m[r]!==n){t[r]={previous:e.prevModelState[r]};e.prevModelState[r]=e.m[r]}});if(r.size(t)>0){this.onModelChanged(t)}},onModelChanged:function(e){"use strict";return e},onDestroyEvent:function(){"use strict";this.parent();me.input.releaseMouseEvent("mousedown",this);me.input.releaseMouseEvent("mouseup",this)}})},{"./game-state":2,"./utils":7,shared:38,underscore:41}],6:[function(e,t,n){var r=e("./tile-entity-vm"),i=e("underscore");var s=t.exports=function(){"use strict";function t(e,t){t=i.defaults(t||{},{duration:30,step:.03});if(e.fadeCountdown===undefined){e.fadeCountdown=t.duration}e.alpha-=t.step;e.fadeCountdown--;if(e.fadeCountdown===0){me.game.remove(e)}}var e={};e.RedColorEntity=r.extend({init:function(e,t){this.size=[1,1];this.parent(e,t,{image:"selector",name:"red"})}});e.ShipDamageOverlay=me.ObjectEntity.extend({init:function(){this.parent(0,0,{image:"nothing"});this.alpha=.5},draw:function(e){this.parent(e);e.save();e.fillStyle="red";e.globalAlpha=this.alpha;e.fillRect(0,0,e.canvas.width,e.canvas.height);e.restore()},update:function(){this.parent();t(this,{duration:10})}});e.DragBox=me.Rect.extend({init:function(e){this.piv=e;this.parent(new me.Vector2d(e.x,e.y),1,1)},draw:function(e){this.parent(e);e.strokeStyle="blue";e.lineWidth=2;e.strokeRect(this.pos.x,this.pos.y,this.width,this.height)},updateFromMouse:function(e){if(e.x>this.piv.x){this.width=e.x-this.piv.x}else{this.pos.x=e.x;this.width=this.piv.x-e.x}if(e.y>this.piv.y){this.height=e.y-this.piv.y}else{this.pos.y=e.y;this.height=this.piv.y-e.y}}});e.StarHit=me.ObjectEntity.extend({init:function(e){this.parent(e.pos.x-8,e.pos.y-8,{image:"star_hit_white",spritewidth:16,spriteheight:16,name:"star_hit"})},update:function(){this.parent();t(this)}});e.FloatingNumber=me.ObjectEntity.extend({fontObject:null,init:function(e,t){var n;this.parent(e.x,e.y,{image:"nothing"});this.pos=e;this.verticalOffset=0;this.value=t;n=t<0?"red":"green";this.fontObject=new me.Font("Lucida Console",14,n)},draw:function(e){this.parent(e);e.save();e.globalAlpha=this.alpha;this.fontObject.draw(me.video.getScreenContext(),this.value,this.pos.x,this.pos.y+this.verticalOffset);e.restore()},update:function(){this.parent();this.verticalOffset-=.3;t(this)}});e.Button=me.GUI_Object.extend({fontObject:null,text:"",init:function(e,t,n,r){if(!r){r={}}if(!r.image){r.image="button"}if(!r.name){r.name="button"}this.parent(t,n,r);this.text=e;this.setTransparency("#FFFFFF");this.fontObject=new me.Font("Arial",16,"white");this.fontObject.bold()},draw:function(e){this.parent(e);this.fontObject.draw(me.video.getScreenContext(),this.text,this.pos.x+20,this.pos.y+24)}});e.ChargingWeaponIcon=me.ObjectEntity.extend({init:function(e){this.parent(e.pos.x-8,e.pos.y-8,{image:"charging-weapon-icon",spritewidth:16,spriteheight:16});this.alpha=.8}});e.layers={items:10,colorOverlay:20,units:30,effects:40,indicators:50};return e}()},{"./tile-entity-vm":5,underscore:41}],7:[function(e,t,n){var r=e("shared"),i=e("./game-state");var s=t.exports={getParameterByName:function(e){"use strict";var t=(new RegExp("[?&]"+e+"=([^&]*)")).exec(window.location.search);return t&&decodeURIComponent(t[1].replace(/\+/g," "))},toTileVector:function(e,t){"use strict";var n=new me.Vector2d;n.x=Math.floor(e.x/t);n.y=Math.floor(e.y/t);return n},getMouse:function(){"use strict";var e=s.toTileVector(s.getMousePx(),i.TILE_SIZE);this.lastMouse=e;return e},getMousePx:function(){"use strict";if(!me.game.currentLevel.initialized){throw"There's no level to get the mouse"}var e=r.v.sub(me.input.mouse.pos,me.game.currentLevel.pos);this.lastMousePx=e;return e},setCursor:function(e){"use strict";if(e!==this.currentCursor){document.getElementById("jsapp").style.cursor=e;this.currentCursor=e}},isMine:function(e){"use strict";var t=e.ownerID;if(t===undefined){t=e.owner.id}return i.player.id===t},isEnemy:function(e){"use strict";return!s.isMine(e)},makeVM:function(e,t,n){"use strict";if(!n){n={}}if(n[e.type]){return new n[e.type](e)}return new t(e)},updateVMs:function(e){"use strict";var t,n,r,i,o=false,u=e.models,a=e.vms,f=e.zIndex,l=e.addToGame,c=e.makeVM||function(t){return s.makeVM(t,e.DefaultConstructor,e.vmConstructors)};if(f===undefined){f=100}if(l===undefined){l=true}for(t=0;t<u.length;t++){r=false;for(n=t;n<a.length;n++){if(u[t]===a[n].m){r=true;break}}if(r){if(n!==t){i=a[n];a[n]=a[t];a[t]=i}}else{a.splice(t,0,c(u[t]));if(l){me.game.add(a[t],f)}o=true}}for(n=u.length;n<a.length;n++){if(l){me.game.remove(a[n],true)}o=true}a.splice(u.length,a.length-u.length);return o},getVM:function(e,t,n){"use strict";var r=t.indexOf(e);if(r!==null&&r!==undefined&&n[r]&&n[r].m===e){return n[r]}throw"Did not find the view model for "+e.type+" in the array. Try calling utils.updateVMs first."}};s.lastMouse={x:0,y:0};s.lastMousePx={x:0,y:0}},{"./game-state":2,shared:38}],8:[function(e,t,n){t.exports=e("./src/PathFinding")},{"./src/PathFinding":9}],9:[function(e,t,n){t.exports={Node:e("./core/Node"),Grid:e("./core/Grid"),Heap:e("./core/Heap"),Util:e("./core/Util"),Heuristic:e("./core/Heuristic"),AStarFinder:e("./finders/AStarFinder"),BestFirstFinder:e("./finders/BestFirstFinder"),BreadthFirstFinder:e("./finders/BreadthFirstFinder"),DijkstraFinder:e("./finders/DijkstraFinder"),BiAStarFinder:e("./finders/BiAStarFinder"),BiBestFirstFinder:e("./finders/BiBestFirstFinder"),BiBreadthFirstFinder:e("./finders/BiBreadthFirstFinder"),BiDijkstraFinder:e("./finders/BiDijkstraFinder"),JumpPointFinder:e("./finders/JumpPointFinder")}},{"./core/Grid":10,"./core/Heap":11,"./core/Heuristic":12,"./core/Node":13,"./core/Util":14,"./finders/AStarFinder":15,"./finders/BestFirstFinder":16,"./finders/BiAStarFinder":17,"./finders/BiBestFirstFinder":18,"./finders/BiBreadthFirstFinder":19,"./finders/BiDijkstraFinder":20,"./finders/BreadthFirstFinder":21,"./finders/DijkstraFinder":22,"./finders/JumpPointFinder":23}],10:[function(e,t,n){function i(e,t,n){this.width=e;this.height=t;this.nodes=this._buildNodes(e,t,n)}var r=e("./Node");i.prototype._buildNodes=function(e,t,n){var i,s,o=new Array(t),u;for(i=0;i<t;++i){o[i]=new Array(e);for(s=0;s<e;++s){o[i][s]=new r(s,i)}}if(n===undefined){return o}if(n.length!==t||n[0].length!==e){throw new Error("Matrix size does not fit")}for(i=0;i<t;++i){for(s=0;s<e;++s){if(n[i][s]){o[i][s].walkable=false}}}return o};i.prototype.getNodeAt=function(e,t){return this.nodes[t][e]};i.prototype.isWalkableAt=function(e,t){return this.isInside(e,t)&&this.nodes[t][e].walkable};i.prototype.isInside=function(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height};i.prototype.setWalkableAt=function(e,t,n){this.nodes[t][e].walkable=n};i.prototype.getNeighbors=function(e,t,n){var r=e.x,i=e.y,s=[],o=false,u=false,a=false,f=false,l=false,c=false,h=false,p=false,d=this.nodes;if(this.isWalkableAt(r,i-1)){s.push(d[i-1][r]);o=true}if(this.isWalkableAt(r+1,i)){s.push(d[i][r+1]);a=true}if(this.isWalkableAt(r,i+1)){s.push(d[i+1][r]);l=true}if(this.isWalkableAt(r-1,i)){s.push(d[i][r-1]);h=true}if(!t){return s}if(n){u=h&&o;f=o&&a;c=a&&l;p=l&&h}else{u=h||o;f=o||a;c=a||l;p=l||h}if(u&&this.isWalkableAt(r-1,i-1)){s.push(d[i-1][r-1])}if(f&&this.isWalkableAt(r+1,i-1)){s.push(d[i-1][r+1])}if(c&&this.isWalkableAt(r+1,i+1)){s.push(d[i+1][r+1])}if(p&&this.isWalkableAt(r-1,i+1)){s.push(d[i+1][r-1])}return s};i.prototype.clone=function(){var e,t,n=this.width,s=this.height,o=this.nodes,u=new i(n,s),a=new Array(s),f;for(e=0;e<s;++e){a[e]=new Array(n);for(t=0;t<n;++t){a[e][t]=new r(t,e,o[e][t].walkable)}}u.nodes=a;return u};t.exports=i},{"./Node":13}],11:[function(e,t,n){(function(){var e,n,r,i,s,o,u,a,f,l,c,h,p,d,v;r=Math.floor,l=Math.min;n=function(e,t){if(e<t){return-1}if(e>t){return 1}return 0};f=function(e,t,i,s,o){var u;if(i==null){i=0}if(o==null){o=n}if(i<0){throw new Error("lo must be non-negative")}if(s==null){s=e.length}while(o(i,s)<0){u=r((i+s)/2);if(o(t,e[u])<0){s=u}else{i=u+1}}return[].splice.apply(e,[i,i-i].concat(t)),t};o=function(e,t,r){if(r==null){r=n}e.push(t);return d(e,0,e.length-1,r)};s=function(e,t){var r,i;if(t==null){t=n}r=e.pop();if(e.length){i=e[0];e[0]=r;v(e,0,t)}else{i=r}return i};a=function(e,t,r){var i;if(r==null){r=n}i=e[0];e[0]=t;v(e,0,r);return i};u=function(e,t,r){var i;if(r==null){r=n}if(e.length&&r(e[0],t)<0){i=[e[0],t],t=i[0],e[0]=i[1];v(e,0,r)}return t};i=function(e,t){var i,s,o,u,a,f,l,c;if(t==null){t=n}f=function(){c=[];for(var t=0,n=r(e.length/2);0<=n?t<n:t>n;0<=n?t++:t--){c.push(t)}return c}.apply(this).reverse();l=[];for(s=0,u=f.length;s<u;s++){i=f[s];l.push(v(e,i,t))}return l};p=function(e,t,r){var i;if(r==null){r=n}i=e.indexOf(t);d(e,0,i,r);return v(e,i,r)};c=function(e,t,r){var s,o,a,f,l;if(r==null){r=n}o=e.slice(0,t);if(!o.length){return o}i(o,r);l=e.slice(t);for(a=0,f=l.length;a<f;a++){s=l[a];u(o,s,r)}return o.sort(r).reverse()};h=function(e,t,r){var o,u,a,c,h,p,d,v,m,g;if(r==null){r=n}if(t*10<=e.length){c=e.slice(0,t).sort(r);if(!c.length){return c}a=c[c.length-1];v=e.slice(t);for(h=0,d=v.length;h<d;h++){o=v[h];if(r(o,a)<0){f(c,o,0,null,r);c.pop();a=c[c.length-1]}}return c}i(e,r);g=[];for(u=p=0,m=l(t,e.length);0<=m?p<m:p>m;u=0<=m?++p:--p){g.push(s(e,r))}return g};d=function(e,t,r,i){var s,o,u;if(i==null){i=n}s=e[r];while(r>t){u=r-1>>1;o=e[u];if(i(s,o)<0){e[r]=o;r=u;continue}break}return e[r]=s};v=function(e,t,r){var i,s,o,u,a;if(r==null){r=n}s=e.length;a=t;o=e[t];i=2*t+1;while(i<s){u=i+1;if(u<s&&!(r(e[i],e[u])<0)){i=u}e[t]=e[i];t=i;i=2*t+1}e[t]=o;return d(e,a,t,r)};e=function(){function e(e){this.cmp=e!=null?e:n;this.nodes=[]}e.name="Heap";e.push=o;e.pop=s;e.replace=a;e.pushpop=u;e.heapify=i;e.nlargest=c;e.nsmallest=h;e.prototype.push=function(e){return o(this.nodes,e,this.cmp)};e.prototype.pop=function(){return s(this.nodes,this.cmp)};e.prototype.peek=function(){return this.nodes[0]};e.prototype.contains=function(e){return this.nodes.indexOf(e)!==-1};e.prototype.replace=function(e){return a(this.nodes,e,this.cmp)};e.prototype.pushpop=function(e){return u(this.nodes,e,this.cmp)};e.prototype.heapify=function(){return i(this.nodes,this.cmp)};e.prototype.updateItem=function(e){return p(this.nodes,e,this.cmp)};e.prototype.clear=function(){return this.nodes=[]};e.prototype.empty=function(){return this.nodes.length===0};e.prototype.size=function(){return this.nodes.length};e.prototype.clone=function(){var t;t=new e;t.nodes=this.nodes.slice(0);return t};e.prototype.toArray=function(){return this.nodes.slice(0)};e.prototype.insert=e.prototype.push;e.prototype.remove=e.prototype.pop;e.prototype.top=e.prototype.peek;e.prototype.front=e.prototype.peek;e.prototype.has=e.prototype.contains;e.prototype.copy=e.prototype.clone;return e}();if(typeof t!=="undefined"&&t!==null?t.exports:void 0){t.exports=e}else{window.Heap=e}}).call(this)},{}],12:[function(e,t,n){t.exports={manhattan:function(e,t){return e+t},euclidean:function(e,t){return Math.sqrt(e*e+t*t)},chebyshev:function(e,t){return Math.max(e,t)}}},{}],13:[function(e,t,n){function r(e,t,n){this.x=e;this.y=t;this.walkable=n===undefined?true:n}t.exports=r},{}],14:[function(e,t,n){function r(e){var t=[[e.x,e.y]];while(e.parent){e=e.parent;t.push([e.x,e.y])}return t.reverse()}function i(e,t){var n=r(e),i=r(t);return n.concat(i.reverse())}function s(e){var t,n=0,r,i,s,o;for(t=1;t<e.length;++t){r=e[t-1];i=e[t];s=r[0]-i[0];o=r[1]-i[1];n+=Math.sqrt(s*s+o*o)}return n}function o(e,t,n,r){var i=Math.abs,s=[],o,u,a,f,l,c;a=i(n-e);f=i(r-t);o=e<n?1:-1;u=t<r?1:-1;l=a-f;while(true){s.push([e,t]);if(e===n&&t===r){break}c=2*l;if(c>-f){l=l-f;e=e+o}if(c<a){l=l+a;t=t+u}}return s}function u(e,t){var n=t.length,r=t[0][0],i=t[0][1],s=t[n-1][0],u=t[n-1][1],a,f,l,c,h,p,d,v,m,g,y,b,w;a=r;f=i;h=t[1][0];p=t[1][1];d=[[a,f]];for(v=2;v<n;++v){g=t[v];l=g[0];c=g[1];y=o(a,f,l,c);w=false;for(m=1;m<y.length;++m){b=y[m];if(!e.isWalkableAt(b[0],b[1])){w=true;d.push([h,p]);a=h;f=p;break}}if(!w){h=l;p=c}}d.push([s,u]);return d}n.backtrace=r;n.biBacktrace=i;n.pathLength=s;n.getLine=o;n.smoothenPath=u},{}],15:[function(e,t,n){function o(e){e=e||{};this.allowDiagonal=e.allowDiagonal;this.dontCrossCorners=e.dontCrossCorners;this.heuristic=e.heuristic||s.manhattan;this.weight=e.weight||1}var r=e("../core/Heap");var i=e("../core/Util");var s=e("../core/Heuristic");o.prototype.findPath=function(e,t,n,s,o){var u=new r(function(e,t){return e.f-t.f}),a=o.getNodeAt(e,t),f=o.getNodeAt(n,s),l=this.heuristic,c=this.allowDiagonal,h=this.dontCrossCorners,p=this.weight,d=Math.abs,v=Math.SQRT2,m,g,y,b,w,E,S,x;a.g=0;a.f=0;u.push(a);a.opened=true;while(!u.empty()){m=u.pop();m.closed=true;if(m===f){return i.backtrace(f)}g=o.getNeighbors(m,c,h);for(b=0,w=g.length;b<w;++b){y=g[b];if(y.closed){continue}E=y.x;S=y.y;x=m.g+(E-m.x===0||S-m.y===0?1:v);if(!y.opened||x<y.g){y.g=x;y.h=y.h||p*l(d(E-n),d(S-s));y.f=y.g+y.h;y.parent=m;if(!y.opened){u.push(y);y.opened=true}else{u.updateItem(y)}}}}return[]};t.exports=o},{"../core/Heap":11,"../core/Heuristic":12,"../core/Util":14}],16:[function(e,t,n){function i(e){r.call(this,e);var t=this.heuristic;this.heuristic=function(e,n){return t(e,n)*1e6}}var r=e("./AStarFinder");i.prototype=new r;i.prototype.constructor=i;t.exports=i},{"./AStarFinder":15}],17:[function(e,t,n){function o(e){e=e||{};this.allowDiagonal=e.allowDiagonal;this.dontCrossCorners=e.dontCrossCorners;this.heuristic=e.heuristic||s.manhattan;this.weight=e.weight||1}var r=e("../core/Heap");var i=e("../core/Util");var s=e("../core/Heuristic");o.prototype.findPath=function(e,t,n,s,o){var u=function(e,t){return e.f-t.f},a=new r(u),f=new r(u),l=o.getNodeAt(e,t),c=o.getNodeAt(n,s),h=this.heuristic,p=this.allowDiagonal,d=this.dontCrossCorners,v=this.weight,m=Math.abs,g=Math.SQRT2,y,b,w,E,S,x,T,N,C=1,k=2;l.g=0;l.f=0;a.push(l);l.opened=C;c.g=0;c.f=0;f.push(c);c.opened=k;while(!a.empty()&&!f.empty()){y=a.pop();y.closed=true;b=o.getNeighbors(y,p,d);for(E=0,S=b.length;E<S;++E){w=b[E];if(w.closed){continue}if(w.opened===k){return i.biBacktrace(y,w)}x=w.x;T=w.y;N=y.g+(x-y.x===0||T-y.y===0?1:g);if(!w.opened||N<w.g){w.g=N;w.h=w.h||v*h(m(x-n),m(T-s));w.f=w.g+w.h;w.parent=y;if(!w.opened){a.push(w);w.opened=C}else{a.updateItem(w)}}}y=f.pop();y.closed=true;b=o.getNeighbors(y,p,d);for(E=0,S=b.length;E<S;++E){w=b[E];if(w.closed){continue}if(w.opened===C){return i.biBacktrace(w,y)}x=w.x;T=w.y;N=y.g+(x-y.x===0||T-y.y===0?1:g);if(!w.opened||N<w.g){w.g=N;w.h=w.h||v*h(m(x-e),m(T-t));w.f=w.g+w.h;w.parent=y;if(!w.opened){f.push(w);w.opened=k}else{f.updateItem(w)}}}}return[]};t.exports=o},{"../core/Heap":11,"../core/Heuristic":12,"../core/Util":14}],18:[function(e,t,n){function i(e){r.call(this,e);var t=this.heuristic;this.heuristic=function(e,n){return t(e,n)*1e6}}var r=e("./BiAStarFinder");i.prototype=new r;i.prototype.constructor=i;t.exports=i},{"./BiAStarFinder":17}],19:[function(e,t,n){function i(e){e=e||{};this.allowDiagonal=e.allowDiagonal;this.dontCrossCorners=e.dontCrossCorners}var r=e("../core/Util");i.prototype.findPath=function(e,t,n,i,s){var o=s.getNodeAt(e,t),u=s.getNodeAt(n,i),a=[],f=[],l,c,h,p=this.allowDiagonal,d=this.dontCrossCorners,v=0,m=1,g,y;a.push(o);o.opened=true;o.by=v;f.push(u);u.opened=true;u.by=m;while(a.length&&f.length){h=a.shift();h.closed=true;l=s.getNeighbors(h,p,d);for(g=0,y=l.length;g<y;++g){c=l[g];if(c.closed){continue}if(c.opened){if(c.by===m){return r.biBacktrace(h,c)}continue}a.push(c);c.parent=h;c.opened=true;c.by=v}h=f.shift();h.closed=true;l=s.getNeighbors(h,p,d);for(g=0,y=l.length;g<y;++g){c=l[g];if(c.closed){continue}if(c.opened){if(c.by===v){return r.biBacktrace(c,h)}continue}f.push(c);c.parent=h;c.opened=true;c.by=m}}return[]};t.exports=i},{"../core/Util":14}],20:[function(e,t,n){function i(e){r.call(this,e);this.heuristic=function(e,t){return 0}}var r=e("./BiAStarFinder");i.prototype=new r;i.prototype.constructor=i;t.exports=i},{"./BiAStarFinder":17}],21:[function(e,t,n){function i(e){e=e||{};this.allowDiagonal=e.allowDiagonal;this.dontCrossCorners=e.dontCrossCorners}var r=e("../core/Util");i.prototype.findPath=function(e,t,n,i,s){var o=[],u=this.allowDiagonal,a=this.dontCrossCorners,f=s.getNodeAt(e,t),l=s.getNodeAt(n,i),c,h,p,d,v;o.push(f);f.opened=true;while(o.length){p=o.shift();p.closed=true;if(p===l){return r.backtrace(l)}c=s.getNeighbors(p,u,a);for(d=0,v=c.length;d<v;++d){h=c[d];if(h.closed||h.opened){continue}o.push(h);h.opened=true;h.parent=p}}return[]};t.exports=i},{"../core/Util":14}],22:[function(e,t,n){function i(e){r.call(this,e);this.heuristic=function(e,t){return 0}}var r=e("./AStarFinder");i.prototype=new r;i.prototype.constructor=i;t.exports=i},{"./AStarFinder":15}],23:[function(e,t,n){function o(e){e=e||{};this.heuristic=e.heuristic||s.manhattan}var r=e("../core/Heap");var i=e("../core/Util");var s=e("../core/Heuristic");o.prototype.findPath=function(e,t,n,s,o){var u=this.openList=new r(function(e,t){return e.f-t.f}),a=this.startNode=o.getNodeAt(e,t),f=this.endNode=o.getNodeAt(n,s),l;this.grid=o;a.g=0;a.f=0;u.push(a);a.opened=true;while(!u.empty()){l=u.pop();l.closed=true;if(l===f){return i.backtrace(f)}this._identifySuccessors(l)}return[]};o.prototype._identifySuccessors=function(e){var t=this.grid,n=this.heuristic,r=this.openList,i=this.endNode.x,o=this.endNode.y,u,a,f,l,c,h=e.x,p=e.y,d,v,m,g,y,b,w,E=Math.abs,S=Math.max;u=this._findNeighbors(e);for(l=0,c=u.length;l<c;++l){a=u[l];f=this._jump(a[0],a[1],h,p);if(f){d=f[0];v=f[1];w=t.getNodeAt(d,v);if(w.closed){continue}y=s.euclidean(E(d-h),E(v-p));b=e.g+y;if(!w.opened||b<w.g){w.g=b;w.h=w.h||n(E(d-i),E(v-o));w.f=w.g+w.h;w.parent=e;if(!w.opened){r.push(w);w.opened=true}else{r.updateItem(w)}}}}};o.prototype._jump=function(e,t,n,r){var i=this.grid,s=e-n,o=t-r,u,a;if(!i.isWalkableAt(e,t)){return null}else if(i.getNodeAt(e,t)===this.endNode){return[e,t]}if(s!==0&&o!==0){if(i.isWalkableAt(e-s,t+o)&&!i.isWalkableAt(e-s,t)||i.isWalkableAt(e+s,t-o)&&!i.isWalkableAt(e,t-o)){return[e,t]}}else{if(s!==0){if(i.isWalkableAt(e+s,t+1)&&!i.isWalkableAt(e,t+1)||i.isWalkableAt(e+s,t-1)&&!i.isWalkableAt(e,t-1)){return[e,t]}}else{if(i.isWalkableAt(e+1,t+o)&&!i.isWalkableAt(e+1,t)||i.isWalkableAt(e-1,t+o)&&!i.isWalkableAt(e-1,t)){return[e,t]}}}if(s!==0&&o!==0){u=this._jump(e+s,t,e,t);a=this._jump(e,t+o,e,t);if(u||a){return[e,t]}}if(i.isWalkableAt(e+s,t)||i.isWalkableAt(e,t+o)){return this._jump(e+s,t+o,e,t)}else{return null}};o.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,r=e.y,i=this.grid,s,o,u,a,f,l,c=[],h,p,d,v;if(t){s=t.x;o=t.y;f=(n-s)/Math.max(Math.abs(n-s),1);l=(r-o)/Math.max(Math.abs(r-o),1);if(f!==0&&l!==0){if(i.isWalkableAt(n,r+l)){c.push([n,r+l])}if(i.isWalkableAt(n+f,r)){c.push([n+f,r])}if(i.isWalkableAt(n,r+l)||i.isWalkableAt(n+f,r)){c.push([n+f,r+l])}if(!i.isWalkableAt(n-f,r)&&i.isWalkableAt(n,r+l)){c.push([n-f,r+l])}if(!i.isWalkableAt(n,r-l)&&i.isWalkableAt(n+f,r)){c.push([n+f,r-l])}}else{if(f===0){if(i.isWalkableAt(n,r+l)){if(i.isWalkableAt(n,r+l)){c.push([n,r+l])}if(!i.isWalkableAt(n+1,r)){c.push([n+1,r+l])}if(!i.isWalkableAt(n-1,r)){c.push([n-1,r+l])}}}else{if(i.isWalkableAt(n+f,r)){if(i.isWalkableAt(n+f,r)){c.push([n+f,r])}if(!i.isWalkableAt(n,r+1)){c.push([n+f,r+1])}if(!i.isWalkableAt(n,r-1)){c.push([n+f,r-1])}}}}}else{h=i.getNeighbors(e,true);for(d=0,v=h.length;d<v;++d){p=h[d];c.push([p.x,p.y])}}return c};t.exports=o},{"../core/Heap":11,"../core/Heuristic":12,"../core/Util":14}],24:[function(e,t,n){var r=t.exports,i=e("underscore")._,s=e("./jsonable").Jsonable,o=e("../general-stuff").v;(function(){"use strict";var e;e=function(e,t,n,r){this.type="ModelChange["+n.type+":"+r+"]";if(e<0){throw"ModelChange timeOffset can't be negative"}this.timeOffset=e;this.label=r;this.apply=function(e){t(e)};this.action=n;this.updateTime()};e.prototype.updateTime=function(){this.time=this.action.time+this.timeOffset};r.ModelChange=e;r.Action=s.extendShared({time:0,modelChanges:[],init:function(e){this.setJson({type:"Action",properties:["time"],json:e})},setTime:function(e){this.time=e;i.invoke(this.modelChanges,"updateTime")},setChanges:function(t){this.modelChanges=[];i.each(t,function(t){this.modelChanges.push(new e(t.offset,t.changer,this,t.label))},this)},toString:function(){return this.time+"ms: "+this.type}});r.actions={};r.actions.Move=r.Action.extendShared({init:function(e){this.parent(e);this.setJson({type:"Move",properties:["unitID","from","to","duration"],json:e})},updateModelChanges:function(){var e=this;this.setChanges([{offset:0,label:"start",changer:function(t){var n=t.getUnitByID(e.unitID);if(n&&n.isAlive()){n.moving={dest:e.to,arrivalTime:e.time+e.duration};n.blocking=false;n.cancelShipWeaponFire()}}},{offset:e.duration,label:"arrive",changer:function(t){var n=t.getUnitByID(e.unitID),r;if(n&&n.isAlive()&&!n.teleported){r={x:n.x,y:n.y};n.y=e.to.y;n.x=e.to.x;n.moving=null;n.dizzy=true;n.moveLock=null;if(!o.equal(r,e.to)){n.ship.unitsMap.update()}n.cancelShipWeaponFire()}}},{offset:e.duration+100,label:"undizzy",changer:function(t){var n=t.getUnitByID(e.unitID);if(n&&n.isAlive()){n.dizzy=false}}}])},toString:function(){return this.time+"ms: Move "+this.unitID+" to "+o.str(this.to)}});r.actions.Attack=r.Action.extendShared({init:function(e){this.parent(e);if(!e.damageDelay){e.damageDelay=0}this.setJson({type:"Attack",properties:["attackerID","receiverID","damage","duration","damageDelay"],json:e});if(this.damageDelay>this.duration){throw"Attack action's damage delay can't be more than the "+"duration"}},updateModelChanges:function(){var e=this;this.setChanges([{offset:0,label:"start",changer:function(t){var n=t.getUnitByID(e.attackerID);n.onCooldown=true}},{offset:e.damageDelay,label:"hit",changer:function(t){var n=t.getUnitByID(e.attackerID),r=t.getUnitByID(e.receiverID);if(n&&n.isAlive()&&r&&r.isAlive()){r.hp-=e.damage;r.cancelShipWeaponFire();r.distracted=true}}},{offset:e.duration,label:"cooldown complete",changer:function(t){var n=t.getUnitByID(e.attackerID);if(n){n.onCooldown=false}}}])},toString:function(){return this.time+"ms: Attack "+this.attackerID+" -> "+this.receiverID}});r.actions.DamageShip=r.Action.extendShared({init:function(e){this.parent(e);this.setJson({type:"DamageShip",properties:["shipID","unitID","tile","damage","cooldown"],json:e})},updateModelChanges:function(){var e=this;this.setChanges([{offset:0,label:"start",changer:function(t){var n=t.getUnitByID(e.unitID),r=t.getShipByID(e.shipID);n.onCooldown=true;r.hp-=e.damage}},{offset:e.cooldown,label:"cooldown complete",changer:function(t){var n=t.getUnitByID(e.unitID);if(n){n.onCooldown=false}}}])},toString:function(){return this.time+"ms: DamageShip, damage: "+this.damage}});r.actions.DeclareWinner=r.Action.extendShared({init:function(e){this.parent(e);this.setJson({type:"DeclareWinner",properties:["playerID"],json:e})},updateModelChanges:function(){var e=this;this.setChanges([{offset:0,label:"start",changer:function(t){t.winner=e.playerID}}])}});r.actions.SetUnitProperty=r.Action.extendShared({init:function(e){this.parent(e);this.setJson({type:"SetUnitProperty",properties:["unitID","property","value"],json:e})},updateModelChanges:function(){var e=this;this.setChanges([{offset:0,label:"start",changer:function(t){var n=t.getUnitByID(e.unitID);n[e.property]=e.value}}])},toString:function(){return this.time+"ms: SetUnitProperty ("+this.unitID+"): "+this.property+" = "+this.value}});r.actions.FinishOrder=r.Action.extendShared({init:function(e){this.parent(e);this.setJson({type:"FinishOrder",properties:["unitID"],json:e})},updateModelChanges:function(){var e=this;this.setChanges([{offset:0,label:"start",changer:function(t){var n=t.getUnitByID(e.unitID);n.orders.shift();t.addUnitOrders(n.makeUnitOrders())}}])}});r.actions.BeginShipWeaponCharge=r.Action.extendShared({init:function(e){this.parent(e);this.setJson({type:"BeginShipWeaponCharge",properties:["unitID","weaponID","chargeTime"],json:e})},updateModelChanges:function(){var e=this;this.setChanges([{offset:0,label:"start",changer:function(t){var n=t.getUnitByID(e.unitID),r=n.ship,i=r.getItemByID(e.weaponID);n.chargingShipWeapon={weaponID:e.weaponID,startingTime:e.time};i.chargedBy=n}},{offset:e.chargeTime,label:"end",changer:function(){return null}}])}});r.actions.FireShipWeapon=r.Action.extendShared({init:function(e){this.parent(e);this.setJson({type:"FireShipWeapon",properties:["unitID","weaponID","targetID"],json:e})},updateModelChanges:function(){var e=this;this.modelChanges=[];this.setChanges([{offset:0,label:"start",changer:function(t){var n=t.getUnitByID(e.unitID);n.cancelShipWeaponFire()}},{offset:800,label:"hit",changer:function(t){var n=t.getUnitByID(e.unitID),r=n.ship,i=t.getShipByID(e.targetID);i.hp-=r.getItemByID(e.weaponID).damage}}])}});r.actions.Teleport=r.Action.extendShared({init:function(e){this.parent(e);this.setJson({type:"Teleport",properties:["unitID","targetShipID","teleporterID"],json:e})},updateModelChanges:function(){var e=this;this.setChanges([{offset:0,label:"start",changer:function(t){var n=t.getUnitByID(e.unitID),r=n.ship.id,i=t.getShipByID(e.targetShipID);n.orders=[];t.addUnitOrders(n.makeUnitOrders());n.ship.removeUnit(n);i.putUnit(n);n.teleported=true;n.teleportSource={teleporterID:e.teleporterID,shipID:r}}}])}});r.actions.Recall=r.Action.extendShared({init:function(e){this.parent(e);this.setJson({type:"Recall",properties:["unitID"],json:e})},updateModelChanges:function(){var e=this;this.setChanges([{offset:0,label:"start",changer:function(t){var n=t.getUnitByID(e.unitID),r=t.getShipByID(n.teleportSource.shipID),i=r.getItemByID(n.teleportSource.teleporterID);n.orders=[];t.addUnitOrders(n.makeUnitOrders());n.ship.removeUnit(n);r.putUnit(n,i);n.teleported=true;n.teleportSource=null}}])}})})()},{"../general-stuff":37,"./jsonable":27,underscore:41}],25:[function(e,t,n){var r=t.exports,i=e("./jsonable").Jsonable,s=e("underscore")._,o=e("./actions").actions,u=e("./ship").Ship,a=e("./player").Player,f=e("./orders").OrderCollection,l=e("../utils").utils;r.Battle=i.extendShared({ships:[],arbiter:{type:"Arbiter",getActions:function(e,t){"use strict";if(t.winner!==undefined){return[]}var n=s.groupBy(t.ships,function(e){return e.hp<=0?"destroyed":"alive"}),r;if(n.destroyed){if(n.alive){return[new o.DeclareWinner({playerID:n.alive[0].owner.id})]}}r=s.chain(t.getUnits()).filter(function(e){return e.isAlive()}).groupBy("ownerID").value();if(s.size(r)===1){return[new o.DeclareWinner({playerID:parseInt(s.keys(r)[0],10)})]}return[]}},init:function(e){"use strict";this.setJson({type:"Battle",properties:["id","turnDuration","winner"],json:e});this.ships=s.map(e.ships,function(e){var t=new u({json:e});t.battle=this;return t},this);this.players=s.map(e.players,function(e){return new a(e)});this.pendingActions=[];this.orderCollection=new f},toJson:function(){"use strict";var e=this.parent();e.ships=l.mapToJson(this.ships);e.players=l.mapToJson(this.players);return e},addShip:function(e){"use strict";e.battle=this;e.id=this.ships.length+1;this.ships.push(e)},getShipByID:function(e){"use strict";return s.findWhere(this.ships,{id:e})},getPlayers:function(){"use strict";return s.pluck(this.ships,"owner")},getActors:function(){"use strict";var e=this.getUnits();e=e.concat(s.filter(this.getItems(),function(e){return e.getActions!==undefined}));e.push(this.arbiter);return e},getUnits:function(){"use strict";return s.flatten(s.pluck(this.ships,"units"))},getItems:function(){"use strict";return s.flatten(s.pluck(this.ships,"built"))},getUnitByID:function(e){"use strict";e=parseInt(e,10);return s.findWhere(this.getUnits(),{id:e})},assignUnitID:function(e){"use strict";var t=this.getUnits();if(t.length===0){e.id=1;return}e.id=s.max(t,function(e){return e.id}).id+1},extractOrders:function(){"use strict";return this.orderCollection},insertOrders:function(e){"use strict";var t=this;s.each(e.allUnitOrders,function(e){t.addUnitOrders(e)})},addUnitOrders:function(e){"use strict";this.orderCollection.addUnitOrders(e);this.getUnitByID(e.unitID).orders=e.array},endOfTurnReset:function(){"use strict";s.invoke(this.ships,"endOfTurnReset",this.turnDuration);s.each(this.orderCollection.allUnitOrders,function(e){if(!this.getUnitByID(e.unitID)){delete this.orderCollection.allUnitOrders[e.unitID]}},this)},getPlayerShips:function(e){"use strict";return s.filter(this.ships,function(t){return t.owner.id===e})},getEnemyShips:function(e){"use strict";return s.filter(this.ships,function(t){return t.owner.id!==e})}})},{"../utils":40,"./actions":24,"./jsonable":27,"./orders":29,"./player":30,"./ship":33,underscore:41}],26:[function(e,t,n){var r=t.exports,i=e("./tile-entity").TileEntity,s=e("underscore")._,o=e("../placement-rules").pr,u=e("../general-stuff"),a=u.GRID_SUB,f=u.tiles;r.Item=i.extendShared({size:[1,1],walkable:false,init:function(e){"use strict";this.parent(e);this.setJson({type:"Item",properties:[],json:e});if(e){this.rotated(e.r);this.ship=e.ship}},canBuildAt:function(e,t,n){"use strict";return this.placementRule.compliesAt(e,t,n.map)},canBuildRotated:function(){"use strict";return false},_rotated:false,rotated:function(e){"use strict";if(e===undefined){return this._rotated}this._rotated=e;return this},trueSize:function(e){"use strict";if(e===undefined){return this.rotated()?[this.size[1],this.size[0]]:this.size}if(this.rotated()){e=e===1?0:1}return this.size[e]},onBuilt:function(){"use strict";return null},onShip:function(e){"use strict";if(e===undefined){return this.ship}this.ship=e;return this},toJson:function(){"use strict";var e=this.parent();e.r=this.rotated();return e},setSize:function(e,t){"use strict";this.size=[e,t];this.onSizeChanged()},onSizeChanged:function(){"use strict";this.placementRule=o.make.spaceRule(f.clear,this.size[0],this.size[1])}});r.items={};r.items.Weapon=r.Item.extendShared({chargeTime:2500,damage:100,init:function(e){"use strict";this.parent(e);this.setJson({type:"Weapon",properties:[],json:e});this.setSize(2*a,2*a)},canBuildAt:function(e,t,n){"use strict";return o.weapon.compliesAt(e,t,n.map)}});r.items.Engine=r.Item.extendShared({init:function(e){"use strict";this.parent(e);this.setJson({type:"Engine",properties:[],json:e});this.setSize(2*a,2*a)},canBuildAt:function(e,t,n){"use strict";return o.Engine.compliesAt(e,t,n.map)}});r.items.Power=r.Item.extendShared({init:function(e){"use strict";this.parent(e);this.setJson({type:"Power",properties:[],json:e});this.setSize(2*a,2*a)}});r.items.Console=r.Item.extendShared({init:function(e){"use strict";this.parent(e);this.setJson({type:"Console",properties:[],json:e});this.setSize(a,a);this.walkable=true},canBuildAt:function(e,t,n){"use strict";return o.console.compliesAt(e,t,n.map)},getControlled:function(){"use strict";var e,t,n;if(this.controlled){return this.controlled}for(t=this.y+a;t>=this.y-a;t-=a){for(e=this.x-a;e<=this.x+a;e+=a){n=this.ship.itemsMap.at(e,t);if(n.type==="Weapon"||n.type==="Engine"||n.type==="Power"){this.controlled=n;return this.controlled}}}}});r.items.Component=r.Item.extendShared({init:function(e){"use strict";this.parent(e);this.setJson({type:"Component",properties:[],json:e});this.setSize(2*a,2*a)}});r.items.Door=r.Item.extendShared({init:function(e){"use strict";this.parent(e);this.setJson({type:"Door",properties:[],json:e});this.setSize(2*a,a);this.walkable=true},canBuildAt:function(e,t,n){"use strict";return o.door.compliesAt(e,t,n.map)},canBuildRotated:function(e,t,n){"use strict";return o.doorRotated.compliesAt(e,t,n.map)}});r.items.Wall=r.Item.extendShared({init:function(e){"use strict";this.parent(e);this.setJson({type:"Wall",properties:[],json:e});this.setSize(a,a);this.connected={top:false,left:true,bottom:false,right:true}},canBuildAt:function(e,t,n){"use strict";return this.parent(e,t,n)||n.at(e,t)instanceof r.items.Wall},onBuilt:function(){"use strict";var e=this.ship.at(this.x,this.y-a),t=this.ship.at(this.x-a,this.y),n=this.ship.at(this.x,this.y+a),r=this.ship.at(this.x+a,this.y);this.updateConnections(e,t,n,r)},updateConnections:function(e,t,n,i){"use strict";var s=r.items,o=this.x,u=this.y;this.connected.top=false;this.connected.left=false;this.connected.bottom=false;this.connected.right=false;if(e instanceof s.Wall){e.connected.bottom=true;this.connected.top=true}else if(e instanceof s.Door&&e.rotated()&&e.y===u-2*a){this.connected.top=true}if(t instanceof s.Wall){t.connected.right=true;this.connected.left=true}else if(t instanceof s.Door&&!t.rotated()&&t.x===o-2*a){this.connected.left=true}if(n instanceof s.Wall){n.connected.top=true;this.connected.bottom=true}else if(n instanceof s.Door&&n.rotated()&&n.y===u+a){this.connected.bottom=true}if(i instanceof s.Wall){i.connected.left=true;this.connected.right=true}else if(i instanceof s.Door&&!i.rotated()&&i.x===o+a){this.connected.right=true}},isHorizontal:function(){"use strict";return!this.connected.top&&!this.connected.bottom},isVertical:function(){"use strict";return!this.connected.left&&!this.connected.right&&(this.connected.top||this.connected.bottom)}});r.items.WeakSpot=r.Item.extendShared({init:function(e){"use strict";this.parent(e);this.setJson({type:"WeakSpot",properties:[],json:e});this.setSize(2*a,2*a);this.walkable=true}});r.items.Teleporter=r.Item.extendShared({init:function(e){"use strict";this.parent(e);this.setJson({type:"Teleporter",properties:[],json:e});this.setSize(a,a);this.walkable=true},getActions:function(t,n){"use strict";var r=this,i=[],o=e("./actions").actions.Teleport;this.tiles(function(e,t){s.each(r.ship.unitsMap.at(e,t),function(e){i.push(new o({unitID:e.id,targetShipID:s.find(n.ships,function(e){return e.id!==r.ship.id}).id,teleporterID:r.id}))})});return i}})},{"../general-stuff":37,"../placement-rules":39,"./actions":24,"./tile-entity":34,underscore:41}],27:[function(e,t,n){var r=t.exports,i=e("./shared-class").SharedClass,s=e("underscore")._;(function(){"use strict";r.Jsonable=i.extendShared({_properties:[],setJson:function(e){var t=e.type,n=e.properties,r=e.json;if(!r){r={}}this.type=t;this._properties=this._properties.concat(n);s.each(n,function(e){if(r[e]===undefined){return}if(r._numbers&&s.isString(r[e])&&s.contains(r._numbers,e)){this[e]=parseFloat(r[e])}else{this[e]=r[e]}},this)},toJson:function(){var e={_numbers:[],type:this.type};s.each(this._properties,function(t){e[t]=this[t];if(s.isNumber(this[t])){e._numbers.push(t)}},this);return e}})})()},{"./shared-class":32,underscore:41}],28:[function(e,t,n){var r=t.exports,i=e("underscore")._,s=e("./shared-class").SharedClass,o=e("../utils").utils;r.Map=s.extendShared({init:function(e){"use strict";var t,n;if(!e){throw"raw parameter mandatory."}n=e[0].length;for(t=e.length-2;t>=0;t--){if(e[t].length!==n){throw"the raw map has not consistent width"}}this.width=n;this.height=e.length;this.raw=e},clear:function(){"use strict";var e=this.raw;this.tiles(function(t,n){e[n][t]=0})},set:function(e,t,n){"use strict";if(this.isInBounds(e,t)){this.raw[t][e]=n}else{throw"Cannot set map at "+e+","+t+": out of bounds."}},at:function(e,t){"use strict";return this.raw[t]!==undefined?this.raw[t][e]:undefined},isInBounds:function(e,t){"use strict";return e>=0&&e<this.width&&t>=0&&t<this.height},tiles:function(e){"use strict";var t,n;for(t=this.height-1;t>=0;t--){for(n=this.width-1;n>=0;n--){e(n,t)}}},scale:function(e){"use strict";var t=[],n,r;if(e===1){return this}i.each(this.raw,function(s,o){o*=e;for(n=0;n<e;n++){t.push([])}i.each(s,function(i,s){s*=e;for(n=0;n<e;n++){for(r=0;r<e;r++){t[o+n][s+r]=i}}})});this.raw=t;this.width=t[0].length;this.height=t.length;return this}});r.EntityMap=r.Map.extendShared({init:function(e,t,n){"use strict";this.parent(o.getEmptyMatrix(e,t,0));this.changed=true;this.entities=n;this.update()},update:function(){"use strict";var e=this;this.clear();i.each(this.entities,function(t){t.tiles(function(n,r){e.set(n,r,t)},e)});this.changed=true}});r.EntityMap3d=r.Map.extendShared({init:function(e,t,n){"use strict";this.parent(o.getEmptyMatrix(e,t,0));this.changed=true;this.entities=n;this.update()},update:function(){"use strict";var e=this;this.clear();i.each(this.entities,function(t){t.tiles(function(n,r){if(!e.at(n,r)){e.set(n,r,[])}e.at(n,r).push(t)},e)});this.changed=true}});r.CompoundMap=r.Map.extendShared({init:function(e){"use strict";if(!e){throw"maps parameter mandatory."}(function(){var t=e[0].width,n=e[0].height,r;for(r=1;r<e.length;r++){if(e[r].width!==t||e[r].height!==n){throw"Maps for Compound should be the same size."}}})();this.width=e[0].width;this.height=e[0].height;this.maps=e},at:function(e,t){"use strict";var n,r;for(n=this.maps.length-1;n>=0;n--){r=this.maps[n].at(e,t);if(r){return r}}return null}})},{"../utils":40,"./shared-class":32,underscore:41}],29:[function(e,t,n){var r=t.exports,i=e("underscore")._,s=e("pathfinding"),o=e("./shared-class").SharedClass,u=e("./jsonable").Jsonable,a=e("../utils").utils,f=e("../general-stuff").v,l=e("./actions").actions,c=e("./items").items;(function(){"use strict";function t(e,t,n,r){var s=t.unitsMap.at(r.x,r.y),o=e+n.getTimeForMoving(n,r,t);return(!s||i.all(s,function(e){return!e.isAlive()||e.moving&&!f.equal(e.moving.dest,r)&&e.moving.arrivalTime<=o}))&&!i.any(t.units,function(e){return e.id!==n.id&&e.moving&&f.equal(e.moving.dest,r)})}var e=new s.AStarFinder({allowDiagonal:true,dontCrossCorners:true});r.OrderCollection=o.extendShared({init:function(e){this.allUnitOrders={};if(e){i.each(e,function(e,t){this.allUnitOrders[t]=new r.UnitOrders(e)},this)}},addUnitOrders:function(e){this.allUnitOrders[e.unitID]=e},getUnitOrders:function(e){return this.allUnitOrders[e]},merge:function(e){i.each(e.allUnitOrders,function(e){if(this.getUnitOrders(e.unitID)){throw"The collection already had orders for unit "+e.unitID}this.addUnitOrders(e)},this)},clone:function(){return new r.OrderCollection(this.toJson())},toJson:function(){var e={};i.each(this.allUnitOrders,function(t,n){e[n]=t.toJson()});return e}});r.UnitOrders=o.extendShared({type:"UnitOrders",init:function(e){this.unitID=parseInt(e.unitID,10);this.array=a.mapFromJson(e.array,r.orders);this.validate(this.unitID)},validate:function(e){if(i.any(this.array,function(t){return t.unitID!==e})){throw"There are orders that don't belong to the unit"}},add:function(e){if(e.unitID!==this.unitID){throw"The order does not belong to the unit"}this.array.push(e)},toJson:function(){return{type:this.type,unitID:this.unitID,array:a.mapToJson(this.array)}}});r.Order=u.extendShared({init:function(e){this.setJson({type:"Order",properties:["unitID"],json:e})},isValid:function(e,t){var n=e.getUnitByID(this.unitID);return n&&n.ownerID===t}});r.orders={};r.orders.GoTo=r.Order.extendShared({init:function(e){this.parent(e)},goTo:function(e,t){var n=this,r=t.getUnitByID(this.unitID),i=r.ship;this.goToState={to:e,arrived:false,path:n.getPath(r,e,i),pathIndex:1}},getPath:function(t,n,r){if(!this.gridForPath){this.gridForPath=new s.Grid(r.width,r.height,r.getPfMatrix())}return e.findPath(t.x,t.y,n.x,n.y,this.gridForPath.clone())},getMoveAction:function(e,n){var r=this.goToState,i,s,o,u;if(r&&!r.arrived){i=n.getUnitByID(this.unitID);s=i.ship;if(f.equal(i,r.to)){r.arrived=true;return null}if(i.moving){return null}if(!r.path||r.pathIndex>=r.path.length){this.goToState.arrived=true;return null}o={x:r.path[r.pathIndex][0],y:r.path[r.pathIndex][1]};if(t(e,s,i,o)){u={x:i.x,y:i.y};r.pathIndex++;return new l.Move({unitID:i.id,from:u,to:o,duration:i.getTimeForMoving(u,o,s)})}return null}return null}});r.orders.Move=r.orders.GoTo.extendShared({init:function(e){this.parent(e);e.destination={x:parseInt(e.destination.x,10),y:parseInt(e.destination.y,10)};this.setJson({type:"Move",properties:["destination"],json:e})},getActions:function(e,t){var n;if(!this.goToState){this.goTo(this.destination,t)}if(!this.goToState.arrived){n=this.getMoveAction(e,t);return n?[n]:[]}return[new l.FinishOrder({unitID:this.unitID})]},toString:function(){return"Move to "+f.str(this.destination)},isValid:function(e,t){var n=e.getUnitByID(this.unitID).ship;return this.parent(e,t)&&n.isWalkable(this.destination.x,this.destination.y)}});r.orders.MoveToConsole=r.orders.Move.extendShared({init:function(e){this.parent(e);this.setJson({type:"MoveToConsole",properties:[],json:e})},toString:function(){return"Move to Console"},isValid:function(e,t){var n=e.getUnitByID(this.unitID).ship;return this.parent(e,t)&&n.itemsMap.at(this.destination.x,this.destination.y)instanceof c.Console}});r.orders.SeekAndDestroy=r.orders.GoTo.extendShared({init:function(e){this.parent(e);this.setJson({type:"SeekAndDestroy",properties:["targetID"],json:e})},getActions:function(e,t){var n,r,i;n=t.getUnitByID(this.unitID);r=t.getUnitByID(this.targetID);if(!r||!r.isAlive()||n.ship!==r.ship){return[new l.SetUnitProperty({unitID:n.id,property:"targetID",value:null}),new l.FinishOrder({unitID:n.id})]}if(n.targetID===null||n.targetID===undefined){return[new l.SetUnitProperty({unitID:n.id,property:"targetID",value:r.id})]}if(n.moving){return[]}if(n.isInRange(r)){return[]}if(!this.goToState||this.pathOutOfTarget(this.goToState.path,r)){this.goTo(r,t)}i=this.getMoveAction(e,t);return i?[i]:[]},pathOutOfTarget:function(e,t){var n=i.last(e);n={x:n[0],y:n[1]};return!f.equal(n,t)},toString:function(){return"Seek & Destroy"},isValid:function(e,t){var n=e.getUnitByID(this.unitID),r=e.getUnitByID(this.targetID);return this.parent(e,t)&&r&&r.isAlive()&&n.isEnemy(r)&&n.ship===r.ship}});r.orders.Recall=r.Order.extendShared({init:function(e){this.parent(e);this.setJson({type:"Recall",properties:[],json:e})},getActions:function(){return[new l.Recall({unitID:this.unitID}),new l.FinishOrder({unitID:this.unitID})]},toString:function(){return"Recall"},isValid:function(e,t){var n=e.getUnitByID(this.unitID);return this.parent(e,t)&&n.teleportSource}})})()},{"../general-stuff":37,"../utils":40,"./actions":24,"./items":26,"./jsonable":27,"./shared-class":32,pathfinding:8,underscore:41}],30:[function(e,t,n){var r=t.exports,i=e("./jsonable").Jsonable;(function(){"use strict";r.Player=i.extendShared({init:function(e){this.setJson({type:"Player",properties:["id","name","state"],json:e})}})})()},{"./jsonable":27}],31:[function(e,t,n){var r=t.exports,i=e("underscore")._,s=e("./shared-class").SharedClass,o=e("../utils").utils,u=e("./actions").actions;(function(){"use strict";r.Script=s.extendShared({turnDuration:0,actions:[],sortedModelChangesIndex:[],init:function(e){if(e){this.actions=e.actions;this.turnDuration=e.turnDuration;this.sort()}this.sortedModelChangesIndex=[]},fromJson:function(e){this.turnDuration=e.turnDuration;this.actions=o.mapFromJson(e.actions,u);i.invoke(this.actions,"updateModelChanges");this.sortedModelChangesIndex=e.sortedModelChangesIndex;this.pendingActionsJson=e.pendingActionsJson;return this},toJson:function(){return{type:"Script",turnDuration:this.turnDuration,actions:o.mapToJson(this.actions),sortedModelChangesIndex:this.sortedModelChangesIndex,pendingActionsJson:this.pendingActionsJson}},isWithinTurn:function(e){return e.time<this.turnDuration&&e.time>=0},sort:function(){this.actions=i.sortBy(this.actions,"time")},insertAction:function(e){var t=i.sortedIndex(this.actions,e,"time");while(this.actions[t]&&this.actions[t].time===e.time){t++}this.actions.splice(t,0,e);return t},byType:function(e){return i.filter(this.actions,function(t){return t.type===e})},registerChange:function(e){if(e.actionIndex===undefined){return}this.sortedModelChangesIndex.push({actionIndex:e.actionIndex,index:e.index})},getSortedModelChanges:function(){return i.map(this.sortedModelChangesIndex,function(e){return this.actions[e.actionIndex].modelChanges[e.index]},this)}})})()},{"../utils":40,"./actions":24,"./shared-class":32,underscore:41}],32:[function(e,t,n){var r=t.exports;(function(){"use strict";var e=false,t=/xyz/.test(function(){xyz})?/\bparent\b/:/.*/;r.SharedClass=function(){};r.SharedClass.extendShared=function(n){function u(){if(!e&&this.init){this.init.apply(this,arguments)}}var i=this.prototype,s,o;e=true;s=new this;e=false;for(o in n){s[o]=typeof n[o]==="function"&&typeof i[o]==="function"&&t.test(n[o])?function(e,t){return function(){var n=this.parent,r;this.parent=i[e];r=t.apply(this,arguments);this.parent=n;return r}}(o,n[o]):n[o]}u.prototype=s;u.constructor=u;u.extendShared=r.SharedClass.extendShared;u.extend=function(){throw new Error('"extendShared" should be called instead of'+' "extend" on a shared entity.')};return u};r.TestSharedEntity=r.SharedClass.extendShared({})})()},{}],33:[function(e,t,n){var r=t.exports,i=e("underscore")._,s=e("./shared-class").SharedClass,o=e("./map"),u=e("../general-stuff"),a=u.GRID_SUB,f=u.tiles,l=e("./items").items,c=e("../utils").utils,h=e("./player").Player,p=e("./units").Unit,d=e("./units").units,v=e("./items").Item,m=e("./orders").orders;r.Ship=s.extendShared({id:null,owner:null,hullMap:{},itemsMap:{},hp:2e3,init:function(e){"use strict";if(!e.tmxName&&!e.json){throw"Ship settings must have tmxName or jsonData"}if(e.json){this.tmxName=e.json.tmxName}else{this.tmxName=e.tmxName}this.loadMap();this.built=[];this.itemsMap=new o.EntityMap(this.width,this.height,this.built);this.units=[];this.unitsMap=new o.EntityMap3d(this.width,this.height,this.units);this.map=new o.CompoundMap([(new o.Map(this.hullMap)).scale(a),this.itemsMap,this.unitsMap]);if(e.json){this.fromJson(e.json)}},loadMap:function(){"use strict";var e;if(!hullMaps){throw"hullMaps global object not found"}e=hullMaps[this.tmxName.toLowerCase()];if(!e){throw'hullMap "'+this.tmxName.toLowerCase()+'" not found'}this.hullMap=e.map;this.width=e.width*a;this.height=e.height*a},buildAt:function(e,t,n){"use strict";var r,i,s,o;r=this;if(!l[n]){throw'No such item type "'+n+'".'}i=new l[n]({});s=i.canBuildAt(e,t,this);if(!s){o=i.canBuildRotated(e,t,this);if(o){i.rotated(true)}}if(s||o){i.x=e;i.y=t;i.tiles(function(e,t){r.removeAt(e,t)},this);this.addItem(i);i.onBuilt();return i}return null},putUnit:function(e,t){"use strict";var n=null,r=this;if(!t){t={x:Math.floor(r.width/2),y:Math.floor(r.height/2)}}n=this.closestTile(t.x,t.y,function(e){return e===f.clear});c.matrixTiles(r.width,r.height,function(e,t){if(n){return}if(r.at(e,t)===f.clear){n={x:e,y:t}}});if(!n){throw new Error("Could not find empty position in ship")}e.x=n.x;e.y=n.y;if(e.ownerID===undefined){e.ownerID=this.owner.id}this.addUnit(e);return e},closestTile:function(e,t,n){"use strict";var r=1,i="right",s,o,u,a;if(n(this.map.at(e,t))){return{x:e,y:t}}u=this.width*2;a=this.height*2;do{switch(i){case"down":i="left";s=[-1,0];break;case"left":i="up";s=[0,-1];break;case"up":i="right";s=[1,0];break;case"right":i="down";s=[0,1];r+=2;e++;t--;break}for(o=0;o<r-1;o++){e+=s[0];t+=s[1];if(n(this.map.at(e,t))){return{x:e,y:t}}}}while(r<u&&r<a);return null},addItem:function(e){"use strict";if(e.id===undefined||e.id===null){this.assignItemID(e)}this.built.push(e);e.onShip(this);this.buildingsChanged()},assignItemID:function(e){"use strict";if(this.built.length===0){e.id=1;return}e.id=i.max(this.built,function(e){return e.id}).id+1},addUnit:function(e){"use strict";if(e.id===undefined||e.id===null){this.battle.assignUnitID(e)}this.units.push(e);e.ship=this;this.unitsMap.update()},getUnitByID:function(e){"use strict";return i.find(this.units,function(t){return t.id===parseInt(e,10)})},getItemByID:function(e){"use strict";return i.find(this.built,function(t){return t.id===parseInt(e,10)})},getPlayerUnits:function(e){"use strict";return i.filter(this.units,function(t){return t.ownerID===e})},removeAt:function(e,t){"use strict";while(!i.isString(this.at(e,t))){this.remove(this.at(e,t),true)}},remove:function(e,t){"use strict";var n;if(!e){return}if(t===undefined){t=true}n=i.indexOf(this.built,e);this.built.splice(n,1);if(t){this.buildingsChanged()}},removeAll:function(){"use strict";var e=this,t;for(t=this.built.length-1;t>=0;t--){e.remove(this.built[t],false)}this.buildingsChanged()},removeUnit:function(e){"use strict";var t=i.indexOf(this.units,e);this.units.splice(t,1);this.unitsMap.update()},buildingsChanged:function(){"use strict";this.itemsMap.update();this.onBuildingsChanged()},onBuildingsChanged:function(){"use strict";return 0},at:function(e,t){"use strict";return this.map.at(e,t)},hasUnits:function(e){"use strict";return this.unitsMap.at(e.x,e.y)},isInside:function(e,t){"use strict";var n=this.at(e,t);return n!==f.solid&&n!==f.front&&n!==f.back},toJson:function(){"use strict";return{tmxName:this.tmxName,id:this.id,hp:this.hp,owner:this.owner?this.owner.toJson():null,buildings:c.mapToJson(this.built),units:c.mapToJson(this.units),GRID_SUB:a}},fromJson:function(e){"use strict";var t=this,n;if(e.id!==undefined){this.id=parseInt(e.id,10)}if(e.hp!==undefined){this.hp=parseInt(e.hp,10)}this.owner=new h(e.owner);if(e.GRID_SUB!==undefined){n=parseInt(e.GRID_SUB,10)}else{n=1}t.removeAll();if(a!==n){console.warn("GRID_SUB from json differs from current GRID_SUB,"+" the values will be converted.")}i.each(e.buildings,function(e){if(a!==n){c.convertPosition(e,n,a)}t.addItem(new l[e.type](e))});i.each(e.units,function(e){if(e.type==="Unit"){t.addUnit(new p(e))}else{t.addUnit(new d[e.type](e))}});this.buildingsChanged()},getPfMatrix:function(){"use strict";var e=this,t=c.getEmptyMatrix(this.width,this.height,1);e.map.tiles(function(n,r){if(e.isWalkable(n,r)){t[r][n]=0}});return t},isWalkable:function(e,t){"use strict";var n=this.map.at(e,t);return n===f.clear||this.hasUnits({x:e,y:t})||n instanceof v&&n.walkable},endOfTurnReset:function(e){"use strict";var t=this,n,r;for(n=0;n<this.units.length;n++){r=this.units[n];if(!r.isAlive()){t.removeUnit(r);n--}else{if(r.chargingShipWeapon){r.chargingShipWeapon.startingTime-=e}r.distracted=false;r.teleported=false}}this.unitsMap.update()},getValidOrderForPos:function(e,t){"use strict";var n=this.map.at(t.x,t.y),r,s;if(i.isArray(n)){r=i.filter(n,function(t){return t instanceof p&&t.isEnemy(e)});if(r.length>0){s=new m.SeekAndDestroy({unitID:e.id,targetID:r[0].id})}}else{if(n instanceof l.Console){s=new m.MoveToConsole({unitID:e.id,destination:{x:t.x,y:t.y}})}else if(this.isWalkable(t.x,t.y)){s=new m.Move({unitID:e.id,destination:{x:t.x,y:t.y}})}}if(s&&s.isValid(this,e.ownerID)){return s}return null}})},{"../general-stuff":37,"../utils":40,"./items":26,"./map":28,"./orders":29,"./player":30,"./shared-class":32,"./units":35,underscore:41}],34:[function(e,t,n){var r=t.exports,i=e("./jsonable").Jsonable;r.TileEntity=i.extendShared({id:null,init:function(e){"use strict";this.setJson({type:"TileEntity",properties:["id","x","y"],json:e})},trueSize:function(e){"use strict";return this.size[e]},tiles:function(e,t){"use strict";var n,r,i=this.trueSize(0),s=this.trueSize(1);for(n=this.x;n<i+this.x&&(!t||n<t.width)&&n>=0;n++){for(r=this.y;r<s+this.y&&(!t||r<t.height)&&r>=0;r++){e(n,r)}}},getTiles:function(){"use strict";var e=[],t,n,r=this.trueSize(0),i=this.trueSize(1);for(t=this.x;t<r+this.x&&t>=0;t++){for(n=this.y;n<i+this.y&&n>=0;n++){e.push({x:t,y:n})}}return e},occupies:function(e){"use strict";var t=e.x,n=e.y;return t>=this.x&&t<this.x+this.trueSize(0)&&n>=this.y&&n<this.y+this.trueSize(1)}})},{"./jsonable":27}],35:[function(e,t,n){var r=t.exports,i=e("underscore")._,s=e("./tile-entity").TileEntity,o=e("./orders").UnitOrders,u=e("./items").items,a=e("./actions").actions,f=e("../general-stuff").v;r.Unit=s.extendShared({imgIndex:0,speed:1,maxHP:100,meleeDamage:20,attackCooldown:500,attackRange:1,imageFacesRight:true,blocking:true,init:function(e){"use strict";this.parent(e);this.size=[1,1];this.setJson({type:"Unit",properties:["imgIndex","speed","maxHP","meleeDamage","attackCooldown","attackRange","imageFacesRight","ownerID","chargingShipWeapon","teleportSource"],json:e});this.hp=this.maxHP;this.inCombat=false;this.orders=[]},makeUnitOrders:function(){"use strict";var e=new o({unitID:this.id});e.array=this.orders;return e},isAlive:function(){"use strict";return this.hp>0},getTimeForOneTile:function(){"use strict";return 1e3/this.speed},getTimeForMoving:function(e,t,n){"use strict";var r=this,s=this.getTimeForOneTile(),o,u,a;o=function(){var n=t.x-e.x,r=t.y-e.y;if(n===0){if(r<0){return-r}return r}if(n<0){return-n}return n}();u=t.x-e.x!==0&&t.y-e.y!==0;if(u){a=o*s*1.41421356}else{a=o*s}if(i.any(n.at(e.x,e.y),function(e){return e.isAlive()&&e.ownerID!==r.ownerID&&e.blocking})){a*=4}return a},getAttackActions:function(){"use strict";var e=[],t=this,n,r;if(!this.onCooldown&&!this.moving&&!this.dizzy){n=i.filter(this.ship.units,function(e){return e.isAlive()&&t.isEnemy(e)&&t.isInRange(e)});if(this.targetID!==null&&this.targetID!==undefined){r=i.where(n,{id:this.targetID})[0]||n[0]}else{r=n[0]}if(r){e.push(new a.Attack({attackerID:t.id,receiverID:r.id,damage:t.meleeDamage,duration:t.attackCooldown}))}}return e},inTeleporter:function(){"use strict";return this.ship.itemsMap.at(this.x,this.y)instanceof u.Teleporter},getOrdersActions:function(e,t){"use strict";var n;if(this.orders.length>0&&!this.inTeleporter()){n=this.orders[0].getActions(e,t);if(e<t.turnDuration){i.chain(n).where({type:"Move"}).each(function(n){if(n.duration+e>t.turnDuration){n.duration=t.turnDuration-e}})}return n}return[]},getDamageShipActions:function(){"use strict";if(this.ownerID!==this.ship.owner.id&&!this.moving&&!this.onCooldown&&!this.dizzy&&!this.inCombat&&this.ship.itemsMap.at(this.x,this.y)instanceof u.WeakSpot){return[new a.DamageShip({shipID:this.ship.id,unitID:this.id,tile:{x:this.x,y:this.y},damage:this.meleeDamage,cooldown:this.attackCooldown})]}return[]},getShipControlActions:function(){"use strict";if(this.ownerID!==this.ship.owner.id){return[]}var e=this.ship.itemsMap.at(this.x,this.y),t;if(e instanceof u.Console){t=e.getControlled()}if(t instanceof u.Weapon&&!t.chargedBy){return[new a.BeginShipWeaponCharge({unitID:this.id,weaponID:t.id,chargeTime:t.chargeTime})]}return[]},getActions:function(e,t){"use strict";var n=[],r;if(!this.isAlive()){return[]}if(e===0&&!this.moving){this.blocking=true}if(!this.chargingShipWeapon){n=n.concat(this.getAttackActions(e,t));if(n.length===0){n=n.concat(this.getDamageShipActions(e,t))}if(!this.distracted){n=n.concat(this.getShipControlActions(e,t))}}else{r=this.ship.getItemByID(this.chargingShipWeapon.weaponID);if(e>=this.chargingShipWeapon.startingTime+r.chargeTime){n.push(new a.FireShipWeapon({unitID:this.id,weaponID:this.chargingShipWeapon.weaponID,targetID:t.getEnemyShips(this.ownerID)[0].id}))}}n=n.concat(this.getOrdersActions(e,t));return n},isEnemy:function(e){"use strict";return e.ownerID!==this.ownerID},isInRange:function(e){"use strict";return f.distance(e,this)<=this.attackRange},cancelShipWeaponFire:function(){"use strict";var e;if(this.chargingShipWeapon){e=this.ship.getItemByID(this.chargingShipWeapon.weaponID);e.chargedBy=null;this.chargingShipWeapon=null}}});r.units=function(){"use strict";var e={};e.Zealot=r.Unit.extendShared({init:function(e){this.imgIndex=0;this.speed=2;this.maxHP=100;this.attackCooldown=800;this.meleeDamage=20;this.attackRange=3;this.parent(e);this.setJson({type:"Zealot",properties:[],json:e})},getAttackActions:function(e,t){return i.map(this.parent(e,t),function(e){e.damageDelay=300;return e})}});e.Critter=r.Unit.extendShared({init:function(e){this.imgIndex=5;this.speed=1;this.maxHP=50;this.attackCooldown=420;this.meleeDamage=8;this.imageFacesRight=false;this.parent(e);this.setJson({type:"Critter",properties:[],json:e})}});e.MetalSpider=r.Unit.extendShared({init:function(e){this.imgIndex=28;this.speed=3;this.maxHP=160;this.attackCooldown=1500;this.meleeDamage=25;this.imageFacesRight=false;this.parent(e);this.setJson({type:"MetalSpider",properties:[],json:e})}});return e}()},{"../general-stuff":37,"./actions":24,"./items":26,"./orders":29,"./tile-entity":34,underscore:41}],36:[function(e,t,n){var r=t.exports,i=e("underscore")._,s=e("./classes/script").Script,o=e("./utils").utils,u=e("./classes/actions").ModelChange;(function(){"use strict";function t(e,t){var n=i.sortedIndex(e,t,"time");e.splice(n,0,t)}function n(e){return new u(0,function(){return null},{time:e})}function a(r,u,a){function b(e){t(l,e)}function w(e,t){return function(n){n.time=t;n.updateModelChanges();f.actions.push(n);i.each(n.modelChanges,function(t,r){if(t.time>=0){t.actionIndex=f.actions.length-1;t.index=r;if(t.time===n.time){t.apply(u);f.registerChange(t);e.immediateChanges.push(n.toString())}else{b(t)}}})}}var f,l,c,h,p,d,v,m={},g=u.turnDuration,y=[];f=new s({turnDuration:g});l=[];u.insertOrders(r);l.push(n(0));i.each(u.pendingActions,function(e){w({},e.time-g)(e)});while(l.length>0&&l[0].time<=g){h=l[0].time;c=i.where(l,{time:h});i.invoke(c,"apply",u);i.each(c,f.registerChange,f);l=l.slice(c.length);if(h<g){m.immediateChanges=[];p=u.getActors();for(v=0;v<p.length;v++){d=p[v];i.each(d.getActions(h,u),w(m,h))}if(m.immediateChanges.length>0){y.push(m.immediateChanges);if(y.length>=e){throw"Too much model changes at the same time ("+h+"ms). Changes stack: "+y.slice(y.length-11,y.length-1).toString()+" ..."}b(n(h))}else{y=[]}}}u.pendingActions=i.chain(l).pluck("action").uniq().value();f.pendingActionsJson=o.mapToJson(u.pendingActions);if(a){u.endOfTurnReset()}return f}var e=500;r.createScript=a})()},{"./classes/actions":24,"./classes/script":31,"./utils":40,underscore:41}],37:[function(e,t,n){var r=t.exports;(function(){"use strict";r.GRID_SUB=2;r.v={sub:function(e,t){return{x:e.x-t.x,y:e.y-t.y}},add:function(e,t){return{x:e.x+t.x,y:e.y+t.y}},mul:function(e,t){return{x:e.x*t,y:e.y*t}},div:function(e,t){return{x:e.x/t,y:e.y/t}},equal:function(e,t){if(!e||!t){return false}return e.x===t.x&&e.y===t.y},map:function(e,t){return{x:t(e.x),y:t(e.y)}},str:function(e){return"("+e.x+", "+e.y+")"},distance:function(e,t){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}};r.tiles={solid:"s",front:"f",back:"b",clear:"."};r.mapNames=["test","cyborg_battleship1","cyborg_cruiser","cyborg_drone","cyborg_frigate","humanoid_battleship","humanoid_cruiser","humanoid_drone","humanoid_frigate","liquid_battleship","liquid_cruiser","liquid_drone","liquid_frigate","mechanoid_battleship","mechanoid_cruiser","mechanoid_drone","mechanoid_frigate"];r.forTesting={};r.getProperties=function(e){var t=[],n;for(n in e){if(e.hasOwnProperty(n)){t.push(n)}}return t}})()},{}],38:[function(e,t,n){var r=e("underscore")._,i={};i.PF=e("pathfinding");t.exports=r.extend(i,e("./general-stuff"),e("./utils"),e("./placement-rules"),e("./classes/shared-class"),e("./classes/jsonable"),e("./classes/player"),e("./classes/tile-entity"),e("./classes/items"),e("./classes/units"),e("./classes/map"),e("./classes/ship"),e("./classes/battle"),e("./classes/actions"),e("./classes/orders"),e("./classes/script"),e("./create-script"))},{"./classes/actions":24,"./classes/battle":25,"./classes/items":26,"./classes/jsonable":27,"./classes/map":28,"./classes/orders":29,"./classes/player":30,"./classes/script":31,"./classes/shared-class":32,"./classes/ship":33,"./classes/tile-entity":34,"./classes/units":35,"./create-script":36,"./general-stuff":37,"./placement-rules":39,"./utils":40,pathfinding:8,underscore:41}],39:[function(e,t,n){var r=t.exports,i=e("underscore")._,s=e("./classes/map").Map,o=e("./general-stuff"),u=o.tiles,a=o.GRID_SUB;r.pr={PlacementRule:function(e){"use strict";var t;this.tile=e.tile;this.inAny=e.inAny;this.inAll=e.inAll;this.tileCondition=e.tileCondition;if(this.tileCondition===undefined&&this.tile!==undefined){t=this.tile;this.tileCondition=function(e){return e===t}}this.compliesAt=function(e,t,n){if(!(n instanceof s)){throw"map should be an instance of sh.Map"}return r.pr.utils.checkAny(n,this.tileCondition,this.inAny,{x:e,y:t})&&r.pr.utils.checkAll(n,this.tileCondition,this.inAll,{x:e,y:t})}},make:{spaceRule:function(e,t,n){"use strict";var s=[],o,u,a;for(u=0;u<n;u++){for(o=0;o<t;o++){s.push({x:o,y:u})}}a={inAll:s};if(i.isFunction(e)){a.tileCondition=e}else{a.tile=e}return new r.pr.PlacementRule(a)},nextToRule:function(e,t,n){"use strict";var s=[],o,u,a;for(o=0;o<t;o++){s.push({x:o,y:-1});s.push({x:o,y:n})}for(u=0;u<n;u++){s.push({x:-1,y:u});s.push({x:t,y:u})}a={inAny:s};if(i.isFunction(e)){a.tileCondition=e}else{a.tile=e}return new r.pr.PlacementRule(a)}},utils:{checkAny:function(e,t,n,i){"use strict";return r.pr.utils.checkAnyOrAll(e,t,n,i,true)},checkAll:function(e,t,n,i){"use strict";return r.pr.utils.checkAnyOrAll(e,t,n,i,false)},checkAnyOrAll:function(e,t,n,r,i){"use strict";var s,o,u;if(!n||n.length===0){return true}for(s=0;s<n.length;s++){o=n[s];u=e.at(r.x+o.x,r.y+o.y);if(i&&u&&t(u)){return true}if(!i&&(!u||!t(u))){return false}}return!i}}};(function(){"use strict";function e(e){return e*a}function f(e,t){return{compliesAt:function(n,r,i){return e.compliesAt(n,r,i)&&t.compliesAt(n,r,i)}}}function l(e,t){return{compliesAt:function(n,r,i){return e.compliesAt(n,r,i)||t.compliesAt(n,r,i)}}}var t=r.pr,n=t.make.spaceRule(u.clear,e(1),e(1)),i=t.make.spaceRule(u.clear,e(2),e(1)),s=t.make.spaceRule(u.clear,e(1),e(2)),o=t.make.spaceRule(u.clear,e(2),e(2));t.weapon=f(o,new r.pr.PlacementRule({tile:u.front,inAny:[{x:e(2),y:e(0)},{x:e(2),y:e(1)}]}));t.Engine=f(o,new r.pr.PlacementRule({tile:u.back,inAll:[{x:e(-1),y:e(0)},{x:e(-1),y:e(1)}]}));t.console=f(n,r.pr.make.nextToRule(function(e){return e.type==="Weapon"||e.type==="Engine"||e.type==="Power"},e(1),e(1)));t.door=l(t.make.spaceRule(function(e){return e.type==="Wall"&&e.isHorizontal()},e(2),e(1)),f(i,new t.PlacementRule({tileCondition:function(e){return e.type==="Wall"},inAll:[{x:e(-1),y:e(0)},{x:e(2),y:e(0)}]})));t.doorRotated=l(t.make.spaceRule(function(e){return e.type==="Wall"&&e.isVertical()},e(1),e(2)),f(s,new t.PlacementRule({tileCondition:function(e){return e.type==="Wall"},inAll:[{x:e(0),y:e(-1)},{x:e(0),y:e(2)}]})))})()},{"./classes/map":28,"./general-stuff":37,underscore:41}],40:[function(e,t,n){var r=t.exports,i=e("underscore")._;r.utils={getEmptyMatrix:function(e,t,n){"use strict";var r=[],i,s;for(i=0;i<t;i++){r.push([]);for(s=0;s<e;s++){r[i].push(n)}}return r},matrixTiles:function(e,t,n){"use strict";var r,i;for(r=0;r<e;r++){for(i=0;i<t;i++){n(r,i)}}},convertPosition:function(e,t,n){"use strict";e.x=e.x*(n/t);e.y=e.y*(n/t)},mapToJson:function(e){"use strict";return i.map(e,function(e){return e.toJson()})},mapFromJson:function(e,t){"use strict";return i.map(e,function(e){return new t[e.type](e)})},removeFromArray:function(e,t){"use strict";var n=t.indexOf(e);if(n>-1){t.splice(n,1)}}}},{underscore:41}],41:[function(e,t,n){(function(){var e=this;var r=e._;var i=Array.prototype,s=Object.prototype,o=Function.prototype;var u=i.push,a=i.slice,f=i.concat,l=s.toString,c=s.hasOwnProperty;var h=Array.isArray,p=Object.keys,d=o.bind;var v=function(e){if(e instanceof v)return e;if(!(this instanceof v))return new v(e);this._wrapped=e};if(typeof n!=="undefined"){if(typeof t!=="undefined"&&t.exports){n=t.exports=v}n._=v}else{e._=v}v.VERSION="1.7.0";var m=function(e,t,n){if(t===void 0)return e;switch(n==null?3:n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,i){return e.call(t,n,r,i)};case 4:return function(n,r,i,s){return e.call(t,n,r,i,s)}}return function(){return e.apply(t,arguments)}};v.iteratee=function(e,t,n){if(e==null)return v.identity;if(v.isFunction(e))return m(e,t,n);if(v.isObject(e))return v.matches(e);return v.property(e)};v.each=v.forEach=function(e,t,n){if(e==null)return e;t=m(t,n);var r,i=e.length;if(i===+i){for(r=0;r<i;r++){t(e[r],r,e)}}else{var s=v.keys(e);for(r=0,i=s.length;r<i;r++){t(e[s[r]],s[r],e)}}return e};v.map=v.collect=function(e,t,n){if(e==null)return[];t=v.iteratee(t,n);var r=e.length!==+e.length&&v.keys(e),i=(r||e).length,s=Array(i),o;for(var u=0;u<i;u++){o=r?r[u]:u;s[u]=t(e[o],o,e)}return s};var g="Reduce of empty array with no initial value";v.reduce=v.foldl=v.inject=function(e,t,n,r){if(e==null)e=[];t=m(t,r,4);var i=e.length!==+e.length&&v.keys(e),s=(i||e).length,o=0,u;if(arguments.length<3){if(!s)throw new TypeError(g);n=e[i?i[o++]:o++]}for(;o<s;o++){u=i?i[o]:o;n=t(n,e[u],u,e)}return n};v.reduceRight=v.foldr=function(e,t,n,r){if(e==null)e=[];t=m(t,r,4);var i=e.length!==+e.length&&v.keys(e),s=(i||e).length,o;if(arguments.length<3){if(!s)throw new TypeError(g);n=e[i?i[--s]:--s]}while(s--){o=i?i[s]:s;n=t(n,e[o],o,e)}return n};v.find=v.detect=function(e,t,n){var r;t=v.iteratee(t,n);v.some(e,function(e,n,i){if(t(e,n,i)){r=e;return true}});return r};v.filter=v.select=function(e,t,n){var r=[];if(e==null)return r;t=v.iteratee(t,n);v.each(e,function(e,n,i){if(t(e,n,i))r.push(e)});return r};v.reject=function(e,t,n){return v.filter(e,v.negate(v.iteratee(t)),n)};v.every=v.all=function(e,t,n){if(e==null)return true;t=v.iteratee(t,n);var r=e.length!==+e.length&&v.keys(e),i=(r||e).length,s,o;for(s=0;s<i;s++){o=r?r[s]:s;if(!t(e[o],o,e))return false}return true};v.some=v.any=function(e,t,n){if(e==null)return false;t=v.iteratee(t,n);var r=e.length!==+e.length&&v.keys(e),i=(r||e).length,s,o;for(s=0;s<i;s++){o=r?r[s]:s;if(t(e[o],o,e))return true}return false};v.contains=v.include=function(e,t){if(e==null)return false;if(e.length!==+e.length)e=v.values(e);return v.indexOf(e,t)>=0};v.invoke=function(e,t){var n=a.call(arguments,2);var r=v.isFunction(t);return v.map(e,function(e){return(r?t:e[t]).apply(e,n)})};v.pluck=function(e,t){return v.map(e,v.property(t))};v.where=function(e,t){return v.filter(e,v.matches(t))};v.findWhere=function(e,t){return v.find(e,v.matches(t))};v.max=function(e,t,n){var r=-Infinity,i=-Infinity,s,o;if(t==null&&e!=null){e=e.length===+e.length?e:v.values(e);for(var u=0,a=e.length;u<a;u++){s=e[u];if(s>r){r=s}}}else{t=v.iteratee(t,n);v.each(e,function(e,n,s){o=t(e,n,s);if(o>i||o===-Infinity&&r===-Infinity){r=e;i=o}})}return r};v.min=function(e,t,n){var r=Infinity,i=Infinity,s,o;if(t==null&&e!=null){e=e.length===+e.length?e:v.values(e);for(var u=0,a=e.length;u<a;u++){s=e[u];if(s<r){r=s}}}else{t=v.iteratee(t,n);v.each(e,function(e,n,s){o=t(e,n,s);if(o<i||o===Infinity&&r===Infinity){r=e;i=o}})}return r};v.shuffle=function(e){var t=e&&e.length===+e.length?e:v.values(e);var n=t.length;var r=Array(n);for(var i=0,s;i<n;i++){s=v.random(0,i);if(s!==i)r[i]=r[s];r[s]=t[i]}return r};v.sample=function(e,t,n){if(t==null||n){if(e.length!==+e.length)e=v.values(e);return e[v.random(e.length-1)]}return v.shuffle(e).slice(0,Math.max(0,t))};v.sortBy=function(e,t,n){t=v.iteratee(t,n);return v.pluck(v.map(e,function(e,n,r){return{value:e,index:n,criteria:t(e,n,r)}}).sort(function(e,t){var n=e.criteria;var r=t.criteria;if(n!==r){if(n>r||n===void 0)return 1;if(n<r||r===void 0)return-1}return e.index-t.index}),"value")};var y=function(e){return function(t,n,r){var i={};n=v.iteratee(n,r);v.each(t,function(r,s){var o=n(r,s,t);e(i,r,o)});return i}};v.groupBy=y(function(e,t,n){if(v.has(e,n))e[n].push(t);else e[n]=[t]});v.indexBy=y(function(e,t,n){e[n]=t});v.countBy=y(function(e,t,n){if(v.has(e,n))e[n]++;else e[n]=1});v.sortedIndex=function(e,t,n,r){n=v.iteratee(n,r,1);var i=n(t);var s=0,o=e.length;while(s<o){var u=s+o>>>1;if(n(e[u])<i)s=u+1;else o=u}return s};v.toArray=function(e){if(!e)return[];if(v.isArray(e))return a.call(e);if(e.length===+e.length)return v.map(e,v.identity);return v.values(e)};v.size=function(e){if(e==null)return 0;return e.length===+e.length?e.length:v.keys(e).length};v.partition=function(e,t,n){t=v.iteratee(t,n);var r=[],i=[];v.each(e,function(e,n,s){(t(e,n,s)?r:i).push(e)});return[r,i]};v.first=v.head=v.take=function(e,t,n){if(e==null)return void 0;if(t==null||n)return e[0];if(t<0)return[];return a.call(e,0,t)};v.initial=function(e,t,n){return a.call(e,0,Math.max(0,e.length-(t==null||n?1:t)))};v.last=function(e,t,n){if(e==null)return void 0;if(t==null||n)return e[e.length-1];return a.call(e,Math.max(e.length-t,0))};v.rest=v.tail=v.drop=function(e,t,n){return a.call(e,t==null||n?1:t)};v.compact=function(e){return v.filter(e,v.identity)};var b=function(e,t,n,r){if(t&&v.every(e,v.isArray)){return f.apply(r,e)}for(var i=0,s=e.length;i<s;i++){var o=e[i];if(!v.isArray(o)&&!v.isArguments(o)){if(!n)r.push(o)}else if(t){u.apply(r,o)}else{b(o,t,n,r)}}return r};v.flatten=function(e,t){return b(e,t,false,[])};v.without=function(e){return v.difference(e,a.call(arguments,1))};v.uniq=v.unique=function(e,t,n,r){if(e==null)return[];if(!v.isBoolean(t)){r=n;n=t;t=false}if(n!=null)n=v.iteratee(n,r);var i=[];var s=[];for(var o=0,u=e.length;o<u;o++){var a=e[o];if(t){if(!o||s!==a)i.push(a);s=a}else if(n){var f=n(a,o,e);if(v.indexOf(s,f)<0){s.push(f);i.push(a)}}else if(v.indexOf(i,a)<0){i.push(a)}}return i};v.union=function(){return v.uniq(b(arguments,true,true,[]))};v.intersection=function(e){if(e==null)return[];var t=[];var n=arguments.length;for(var r=0,i=e.length;r<i;r++){var s=e[r];if(v.contains(t,s))continue;for(var o=1;o<n;o++){if(!v.contains(arguments[o],s))break}if(o===n)t.push(s)}return t};v.difference=function(e){var t=b(a.call(arguments,1),true,true,[]);return v.filter(e,function(e){return!v.contains(t,e)})};v.zip=function(e){if(e==null)return[];var t=v.max(arguments,"length").length;var n=Array(t);for(var r=0;r<t;r++){n[r]=v.pluck(arguments,r)}return n};v.object=function(e,t){if(e==null)return{};var n={};for(var r=0,i=e.length;r<i;r++){if(t){n[e[r]]=t[r]}else{n[e[r][0]]=e[r][1]}}return n};v.indexOf=function(e,t,n){if(e==null)return-1;var r=0,i=e.length;if(n){if(typeof n=="number"){r=n<0?Math.max(0,i+n):n}else{r=v.sortedIndex(e,t);return e[r]===t?r:-1}}for(;r<i;r++)if(e[r]===t)return r;return-1};v.lastIndexOf=function(e,t,n){if(e==null)return-1;var r=e.length;if(typeof n=="number"){r=n<0?r+n+1:Math.min(r,n+1)}while(--r>=0)if(e[r]===t)return r;return-1};v.range=function(e,t,n){if(arguments.length<=1){t=e||0;e=0}n=n||1;var r=Math.max(Math.ceil((t-e)/n),0);var i=Array(r);for(var s=0;s<r;s++,e+=n){i[s]=e}return i};var w=function(){};v.bind=function(e,t){var n,r;if(d&&e.bind===d)return d.apply(e,a.call(arguments,1));if(!v.isFunction(e))throw new TypeError("Bind must be called on a function");n=a.call(arguments,2);r=function(){if(!(this instanceof r))return e.apply(t,n.concat(a.call(arguments)));w.prototype=e.prototype;var i=new w;w.prototype=null;var s=e.apply(i,n.concat(a.call(arguments)));if(v.isObject(s))return s;return i};return r};v.partial=function(e){var t=a.call(arguments,1);return function(){var n=0;var r=t.slice();for(var i=0,s=r.length;i<s;i++){if(r[i]===v)r[i]=arguments[n++]}while(n<arguments.length)r.push(arguments[n++]);return e.apply(this,r)}};v.bindAll=function(e){var t,n=arguments.length,r;if(n<=1)throw new Error("bindAll must be passed function names");for(t=1;t<n;t++){r=arguments[t];e[r]=v.bind(e[r],e)}return e};v.memoize=function(e,t){var n=function(r){var i=n.cache;var s=t?t.apply(this,arguments):r;if(!v.has(i,s))i[s]=e.apply(this,arguments);return i[s]};n.cache={};return n};v.delay=function(e,t){var n=a.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)};v.defer=function(e){return v.delay.apply(v,[e,1].concat(a.call(arguments,1)))};v.throttle=function(e,t,n){var r,i,s;var o=null;var u=0;if(!n)n={};var a=function(){u=n.leading===false?0:v.now();o=null;s=e.apply(r,i);if(!o)r=i=null};return function(){var f=v.now();if(!u&&n.leading===false)u=f;var l=t-(f-u);r=this;i=arguments;if(l<=0||l>t){clearTimeout(o);o=null;u=f;s=e.apply(r,i);if(!o)r=i=null}else if(!o&&n.trailing!==false){o=setTimeout(a,l)}return s}};v.debounce=function(e,t,n){var r,i,s,o,u;var a=function(){var f=v.now()-o;if(f<t&&f>0){r=setTimeout(a,t-f)}else{r=null;if(!n){u=e.apply(s,i);if(!r)s=i=null}}};return function(){s=this;i=arguments;o=v.now();var f=n&&!r;if(!r)r=setTimeout(a,t);if(f){u=e.apply(s,i);s=i=null}return u}};v.wrap=function(e,t){return v.partial(t,e)};v.negate=function(e){return function(){return!e.apply(this,arguments)}};v.compose=function(){var e=arguments;var t=e.length-1;return function(){var n=t;var r=e[t].apply(this,arguments);while(n--)r=e[n].call(this,r);return r}};v.after=function(e,t){return function(){if(--e<1){return t.apply(this,arguments)}}};v.before=function(e,t){var n;return function(){if(--e>0){n=t.apply(this,arguments)}else{t=null}return n}};v.once=v.partial(v.before,2);v.keys=function(e){if(!v.isObject(e))return[];if(p)return p(e);var t=[];for(var n in e)if(v.has(e,n))t.push(n);return t};v.values=function(e){var t=v.keys(e);var n=t.length;var r=Array(n);for(var i=0;i<n;i++){r[i]=e[t[i]]}return r};v.pairs=function(e){var t=v.keys(e);var n=t.length;var r=Array(n);for(var i=0;i<n;i++){r[i]=[t[i],e[t[i]]]}return r};v.invert=function(e){var t={};var n=v.keys(e);for(var r=0,i=n.length;r<i;r++){t[e[n[r]]]=n[r]}return t};v.functions=v.methods=function(e){var t=[];for(var n in e){if(v.isFunction(e[n]))t.push(n)}return t.sort()};v.extend=function(e){if(!v.isObject(e))return e;var t,n;for(var r=1,i=arguments.length;r<i;r++){t=arguments[r];for(n in t){if(c.call(t,n)){e[n]=t[n]}}}return e};v.pick=function(e,t,n){var r={},i;if(e==null)return r;if(v.isFunction(t)){t=m(t,n);for(i in e){var s=e[i];if(t(s,i,e))r[i]=s}}else{var o=f.apply([],a.call(arguments,1));e=new Object(e);for(var u=0,l=o.length;u<l;u++){i=o[u];if(i in e)r[i]=e[i]}}return r};v.omit=function(e,t,n){if(v.isFunction(t)){t=v.negate(t)}else{var r=v.map(f.apply([],a.call(arguments,1)),String);t=function(e,t){return!v.contains(r,t)}}return v.pick(e,t,n)};v.defaults=function(e){if(!v.isObject(e))return e;for(var t=1,n=arguments.length;t<n;t++){var r=arguments[t];for(var i in r){if(e[i]===void 0)e[i]=r[i]}}return e};v.clone=function(e){if(!v.isObject(e))return e;return v.isArray(e)?e.slice():v.extend({},e)};v.tap=function(e,t){t(e);return e};var E=function(e,t,n,r){if(e===t)return e!==0||1/e===1/t;if(e==null||t==null)return e===t;if(e instanceof v)e=e._wrapped;if(t instanceof v)t=t._wrapped;var i=l.call(e);if(i!==l.call(t))return false;switch(i){case"[object RegExp]":case"[object String]":return""+e===""+t;case"[object Number]":if(+e!==+e)return+t!==+t;return+e===0?1/+e===1/t:+e===+t;case"[object Date]":case"[object Boolean]":return+e===+t}if(typeof e!="object"||typeof t!="object")return false;var s=n.length;while(s--){if(n[s]===e)return r[s]===t}var o=e.constructor,u=t.constructor;if(o!==u&&"constructor"in e&&"constructor"in t&&!(v.isFunction(o)&&o instanceof o&&v.isFunction(u)&&u instanceof u)){return false}n.push(e);r.push(t);var a,f;if(i==="[object Array]"){a=e.length;f=a===t.length;if(f){while(a--){if(!(f=E(e[a],t[a],n,r)))break}}}else{var c=v.keys(e),h;a=c.length;f=v.keys(t).length===a;if(f){while(a--){h=c[a];if(!(f=v.has(t,h)&&E(e[h],t[h],n,r)))break}}}n.pop();r.pop();return f};v.isEqual=function(e,t){return E(e,t,[],[])};v.isEmpty=function(e){if(e==null)return true;if(v.isArray(e)||v.isString(e)||v.isArguments(e))return e.length===0;for(var t in e)if(v.has(e,t))return false;return true};v.isElement=function(e){return!!(e&&e.nodeType===1)};v.isArray=h||function(e){return l.call(e)==="[object Array]"};v.isObject=function(e){var t=typeof e;return t==="function"||t==="object"&&!!e};v.each(["Arguments","Function","String","Number","Date","RegExp"],function(e){v["is"+e]=function(t){return l.call(t)==="[object "+e+"]"}});if(!v.isArguments(arguments)){v.isArguments=function(e){return v.has(e,"callee")}}if(typeof /./!=="function"){v.isFunction=function(e){return typeof e=="function"||false}}v.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))};v.isNaN=function(e){return v.isNumber(e)&&e!==+e};v.isBoolean=function(e){return e===true||e===false||l.call(e)==="[object Boolean]"};v.isNull=function(e){return e===null};v.isUndefined=function(e){return e===void 0};v.has=function(e,t){return e!=null&&c.call(e,t)};v.noConflict=function(){e._=r;return this};v.identity=function(e){return e};v.constant=function(e){return function(){return e}};v.noop=function(){};v.property=function(e){return function(t){return t[e]}};v.matches=function(e){var t=v.pairs(e),n=t.length;return function(e){if(e==null)return!n;e=new Object(e);for(var r=0;r<n;r++){var i=t[r],s=i[0];if(i[1]!==e[s]||!(s in e))return false}return true}};v.times=function(e,t,n){var r=Array(Math.max(0,e));t=m(t,n,1);for(var i=0;i<e;i++)r[i]=t(i);return r};v.random=function(e,t){if(t==null){t=e;e=0}return e+Math.floor(Math.random()*(t-e+1))};v.now=Date.now||function(){return(new Date).getTime()};var S={"&":"&","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};var x=v.invert(S);var T=function(e){var t=function(t){return e[t]};var n="(?:"+v.keys(e).join("|")+")";var r=RegExp(n);var i=RegExp(n,"g");return function(e){e=e==null?"":""+e;return r.test(e)?e.replace(i,t):e}};v.escape=T(S);v.unescape=T(x);v.result=function(e,t){if(e==null)return void 0;var n=e[t];return v.isFunction(n)?e[t]():n};var N=0;v.uniqueId=function(e){var t=++N+"";return e?e+t:t};v.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var C=/(.)^/;var k={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"};var L=/\\|'|\r|\n|\u2028|\u2029/g;var A=function(e){return"\\"+k[e]};v.template=function(e,t,n){if(!t&&n)t=n;t=v.defaults({},t,v.templateSettings);var r=RegExp([(t.escape||C).source,(t.interpolate||C).source,(t.evaluate||C).source].join("|")+"|$","g");var i=0;var s="__p+='";e.replace(r,function(t,n,r,o,u){s+=e.slice(i,u).replace(L,A);i=u+t.length;if(n){s+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"}else if(r){s+="'+\n((__t=("+r+"))==null?'':__t)+\n'"}else if(o){s+="';\n"+o+"\n__p+='"}return t});s+="';\n";if(!t.variable)s="with(obj||{}){\n"+s+"}\n";s="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{var o=new Function(t.variable||"obj","_",s)}catch(u){u.source=s;throw u}var a=function(e){return o.call(this,e,v)};var f=t.variable||"obj";a.source="function("+f+"){\n"+s+"}";return a};v.chain=function(e){var t=v(e);t._chain=true;return t};var O=function(e){return this._chain?v(e).chain():e};v.mixin=function(e){v.each(v.functions(e),function(t){var n=v[t]=e[t];v.prototype[t]=function(){var e=[this._wrapped];u.apply(e,arguments);return O.call(this,n.apply(v,e))}})};v.mixin(v);v.each(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=i[e];v.prototype[e]=function(){var n=this._wrapped;t.apply(n,arguments);if((e==="shift"||e==="splice")&&n.length===0)delete n[0];return O.call(this,n)}});v.each(["concat","join","slice"],function(e){var t=i[e];v.prototype[e]=function(){return O.call(this,t.apply(this._wrapped,arguments))}});v.prototype.value=function(){return this._wrapped};if(typeof define==="function"&&define.amd){define("underscore",[],function(){return v})}}).call(this)},{}],42:[function(e,t,n){function r(e){"use strict";var t=e.split("_")[0];return[{name:e,type:"tmx",src:"/_common/outlines/"+e+".tmx"},{name:e+"_img",type:"image",src:"/_common/img/render/ships/"+t+"/"+e+"_img.png"}]}var i=[{name:"outline",type:"image",src:"/_common/img/render/outline.png"},{name:"selector",type:"image",src:"/_common/img/render/selector.png"},{name:"pause-icon",type:"image",src:"/_common/img/render/pause-icon.png"},{name:"weapon",type:"image",src:"/_common/img/render/weapon_01.png"},{name:"engine",type:"image",src:"/_common/img/render/engine_01.png"},{name:"power",type:"image",src:"/_common/img/render/power_01.png"},{name:"console",type:"image",src:"/_common/img/render/console_02.png"},{name:"component",type:"image",src:"/_common/img/render/components_01.png"},{name:"door",type:"image",src:"/_common/img/render/door_01.png"},{name:"wall",type:"image",src:"/_common/img/render/wall_001.png"},{name:"weakspot",type:"image",src:"/_common/img/render/weakspot.png"},{name:"teleporter",type:"image",src:"/_common/img/render/teleporter.png"},{name:"metatiles32x32",type:"image",src:"/_common/img/render/metatiles32x32.png"},{name:"area_01",type:"tmx",src:"/_common/outlines/small.tmx"},{name:"test",type:"tmx",src:"/_common/outlines/test.tmx"},{name:"button",type:"image",src:"/_common/img/render/button.png"},{name:"creatures",type:"image",src:"/_common/img/render/creatures.png"},{name:"creatures_16x16",type:"image",src:"/_common/img/render/creatures_16x16.png"},{name:"star_hit_white",type:"image",src:"/_common/img/render/star_hit_white.png"},{name:"nothing",type:"image",src:"/_common/img/render/nothing.png"},{name:"projectile",type:"image",src:"/_common/img/render/projectile.png"},{name:"markers",type:"image",src:"/_common/img/render/markers.png"},{name:"charging-weapon-icon",type:"image",src:"/_common/img/render/charging-weapon-icon.png"}];i=i.concat(r(bootstrapped.shipJson.tmxName));t.exports=i},{}],43:[function(e,t,n){var r,i,s,o,u;i=e("client/game-state");s=e("shared");i.TILE_SIZE=32/s.GRID_SUB;i.HALF_TILE=16/s.GRID_SUB;o=e("./ship-building-screen");u=e("./assets");e("client/melonjs-plugins");r={loadReady:false,onload:function(){"use strict";if(!me.video.init("jsapp",1440,1344)){alert("Sorry but your browser does not support html 5 canvas.");return}me.loader.onload=this.loaded.bind(this);me.loader.preload(u);me.state.change(me.state.LOADING)},loaded:function(){"use strict";var e=this;i.player=new s.Player({id:777,name:"hardcoded name"});me.state.set("ship-building",new o);me.state.change("ship-building");e.loadReady=true;e.onAppLoaded()},onAppLoaded:function(){"use strict";return 0}};window.onReady(function(){"use strict";r.onload()})},{"./assets":42,"./ship-building-screen":44,"client/game-state":2,"client/melonjs-plugins":4,shared:38}],44:[function(e,t,n){var r=e("shared"),i=e("./ship-vm"),s=e("client/utils"),o=e("client/item-vms").itemVMs,u=e("client/ui"),a=e("underscore")._;t.exports=me.ScreenObject.extend({ship:null,prevMouse:{},init:function(){"use strict";this.parent(true)},onResetEvent:function(){"use strict";var e=this;this.ship=new r.Ship({json:bootstrapped.shipJson});this.shipVM=new i(this.ship);this.shipVM.showInScreen();this.ship.onBuildingsChanged=function(){e.updateGreenSpots()};me.game.sort();me.input.bindKey(me.input.KEY.ESC,"escape");me.input.registerMouseEvent("mousedown",me.game.viewport,this.mouseDown.bind(this));me.input.registerMouseEvent("mousemove",me.game.viewport,this.mouseMove.bind(this));me.input.registerMouseEvent("mouseup",me.game.viewport,this.mouseUp.bind(this));me.input.registerMouseEvent("dblclick",me.game.viewport,this.mouseDbClick.bind(this));this.mouseLockedOn=null;this.prepareGhostItems();this.greenSpots=r.utils.getEmptyMatrix(this.ship.width,this.ship.height,1);this.onHtmlLoaded()},onDestroyEvent:function(){"use strict";me.input.unbindKey(me.input.KEY.ESC);me.input.releaseMouseEvent("mousedown",me.game.viewport);me.input.releaseMouseEvent("mousemove",me.game.viewport);me.input.releaseMouseEvent("mouseup",me.game.viewport);me.input.releaseMouseEvent("dblclick",me.game.viewport)},update:function(){"use strict";this.shipVM.update();if(me.input.isKeyPressed("escape")){if(this.mouseLockedOn){this.mouseLockedOn.lockedEscape();return}if(this.chosen){this.choose()}}a.each(this.drawingScreen,function(e){e.update()})},draw:function(e){"use strict";this.parent(e);a.each(this.drawingScreen,function(t){t.draw(e)})},onHtmlLoaded:function(){"use strict";var e=this;$(".item").click(function(){var e,t;if(me.state.isCurrent(me.state.LOADING)){return}e=$("img",this).attr("id");t=e.substring(5,e.length);me.state.current().choose(t)});$("#file_save").click(function(){var t=e.ship.toJson();$.post("/ship/save",{hullID:bootstrapped.hullID,name:$("#ship-name").val(),tier:$("#ship-tier").val(),jsonString:JSON.stringify(t)},function(e){if(e){location.href="/ship-list?edit=true"}else{alert("Error: Could not save ship.")}},"json")});$("#jsapp").find("canvas").css({width:"",height:""})},mouseDbClick:function(){"use strict";var e,t=me.state.current();e=s.toTileVector(s.getMousePx(),32);e=r.v.mul(e,r.GRID_SUB);if(t.mouseLockedOn){t.mouseLockedOn.lockedMouseDbClick(e);return}me.game.sort();me.game.repaint()},mouseDown:function(e){"use strict";var t,n,i;i=e.which-1;t=s.toTileVector(s.getMousePx(),32);t=r.v.mul(t,r.GRID_SUB);if(this.mouseLockedOn){this.mouseLockedOn.lockedMouseDown(t);return}n=this.ship.at(t.x,t.y);if(n!==null&&n instanceof r.Item){if(i===me.input.mouse.RIGHT){this.deleteItem(n)}else{this.selected=n;if(!this.chosen){this.beginDrag(n)}}}me.game.sort();me.game.repaint()},mouseMove:function(){"use strict";var e=s.toTileVector(s.getMousePx(),32);if(this.prevMouse.x===e.x&&this.prevMouse.y===e.y){return}this.prevMouse.x=e.x;this.prevMouse.y=e.y;e=r.v.mul(e,r.GRID_SUB);if(this.mouseLockedOn){this.mouseLockedOn.lockedMouseMove(e);if(this.mouseLockedOn.type==="Wall"||this.mouseLockedOn.type==="Door"){this.updateWalls()}return}if(!this.chosen){return}this.moveGhost(e.x,e.y);if(this.chosen.type==="Wall"||this.chosen.type==="Door"){this.updateWalls()}me.game.sort();me.game.repaint()},mouseUp:function(e){"use strict";var t,n;n=e.which-1;t=s.toTileVector(s.getMousePx(),32);t=r.v.mul(t,r.GRID_SUB);if(this.mouseLockedOn){this.mouseLockedOn.lockedMouseUp(t);me.game.sort();me.game.repaint();return}if(this.chosen&&!this.dragging){if(n===me.input.mouse.LEFT){this.buildItem(t.x,t.y,this.chosen.type);if(this.chosen.type==="Door"||this.chosen.type==="Wall"){this.updateWalls()}}}else if(this.dragging){this.endDrag(t)}me.game.sort();me.game.repaint()},updateWalls:function(){"use strict";var e=a.union(me.game.getEntityByName("item"),this.drawingScreen);a.invoke(a.where(e,{type:"Wall"}),"updateAnimation")},buildItem:function(e,t,n){"use strict";var r=this.ship.buildAt(e,t,n);if(r){this.shipVM.update();this.shipVM.getVM(r).onBuilt()}},deleteItem:function(e){"use strict";this.ship.remove(e,true);this.updateRed()},makeItem:function(e,t){"use strict";var n,i;i=new r.items[e](t);n=o[e];return new n(i)},chosen:null,mouseLockedOn:null,ghostItems:{},prepareGhostItems:function(){"use strict";var e,t;this.ghostItems={};for(e in o){if(o.hasOwnProperty(e)){t=this.makeItem(e,{x:0,y:0});this.ghostItems[e]=t;t.hide();me.game.add(t,u.layers.indicators);t.onShip(false)}}},choose:function(e){"use strict";if(this.chosen){if(this.chosen.type===e){return}this.chosen.hide();this.clearRed();$("#item_"+this.chosen.type).removeClass("chosen");me.game.repaint()}this.chosen=this.ghostItems[e];if(!this.chosen){this.chosen=null;return}var t=s.getMouse();this.chosen.setX(t.x).setY(t.y).show().alpha=.8;this.updateGreenSpots();$("#item_"+this.chosen.type).addClass("chosen");me.game.sort();me.game.repaint()},moveGhost:function(e,t){"use strict";this.chosen.setX(e).setY(t);if(!this.chosen.rotated()&&this.chosen.m.canBuildRotated(e,t,this.ship)){this.chosen.rotated(true)}if(this.chosen.rotated()&&this.chosen.m.canBuildAt(e,t,this.ship)){this.chosen.rotated(false)}this.updateRed()},dragging:null,beginDrag:function(e){"use strict";if(this.chosen){console.log("There should be nothing chosen when drag begins. "+"(this.beginDrag)")}this.ship.remove(e,true);this.choose(e.type);this.dragging=e},endDrag:function(e){"use strict";if(!this.dragging){return}if(this.dragging.canBuildAt(e.x,e.y,this.ship)){this.dragging.x=e.x;this.dragging.y=e.y}this.ship.addItem(this.dragging);this.choose();this.dragging=null;this.shipVM.update()},redScreen:[],redIndex:0,printRed:function(e,t){"use strict";this.redScreen[this.redIndex]=new u.RedColorEntity(e,t,{});me.game.add(this.redScreen[this.redIndex],u.layers.colorOverlay);this.redIndex++},clearRed:function(){"use strict";var e;for(e=this.redIndex;e>0;e--){me.game.remove(this.redScreen[e-1]);this.redScreen.pop()}this.redIndex=0},updateRed:function(){"use strict";this.clearRed();var e=this;if(this.chosen){this.chosen.tiles(function(t,n){if(e.greenSpots[n][t]===1){e.printRed(t,n)}},e.ship)}},greenSpots:null,updateGreenSpots:function(){"use strict";var e=this,t=this.ship;if(!this.chosen){return}e.greenSpots=r.utils.getEmptyMatrix(t.width,t.height,1);t.map.tiles(function(n,r){var i,s,o,u;if(e.chosen.m.canBuildAt(n,r,t)){o=e.chosen.size[0];u=e.chosen.size[1]}if(e.chosen.m.canBuildRotated(n,r,t)){o=e.chosen.size[1];u=e.chosen.size[0]}for(i=n;i<o+n&&i<t.width;i++){for(s=r;s<u+r&&s<t.height;s++){e.greenSpots[s][i]=0}}})},drawingScreen:[],drawItem:function(e,t,n){"use strict";var r=this.makeItem(n,{x:e,y:t});r.alpha=.8;this.drawingScreen.push(r);me.game.repaint()},clear:function(){"use strict";this.drawingScreen=[];this.clearRed();me.game.repaint()},at:function(e,t){"use strict";var n,i;for(n=0;n<this.drawingScreen.length;n++){if(this.drawingScreen[n].occupies({x:e,y:t})){return this.drawingScreen[n]}}i=this.ship.map.at(e,t);if(i===r.tiles.clear&&this.chosen&&this.chosen.occupies({x:e,y:t})){return this.chosen}return i}})},{"./ship-vm":45,"client/item-vms":3,"client/ui":6,"client/utils":7,shared:38,underscore:41}],45:[function(e,t,n){var r=e("client/utils"),i=e("client/item-vms").ItemVM,s=e("client/item-vms").itemVMs,o=e("client/ui");var u=t.exports=function(e){"use strict";this.itemVMs=[];this.m=e;this.showInScreen=function(){me.levelDirector.loadLevel(this.m.tmxName)};this.update=function(){var e=false;if(this.updateItems()){e=true}if(e){me.game.sort()}return e};this.updateItems=function(){return r.updateVMs({models:this.m.built,vms:this.itemVMs,zIndex:o.layers.items,DefaultConstructor:i,vmConstructors:s})};this.draw=function(e){return e};this.getVM=function(e){return r.getVM(e,this.m.built,this.itemVMs)}}},{"client/item-vms":3,"client/ui":6,"client/utils":7}]},{},[43])